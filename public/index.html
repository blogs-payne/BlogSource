<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="theme-color" content="#222">
    <meta name="generator" content="Hexo 4.2.1">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16-next.png">
    <link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222">
    <meta name="msapplication-config" content="/images/favicon/browserconfig.xml">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
    <link rel="stylesheet" href="/lib/pace/pace-theme-mac-osx.min.css">
    <script src="/lib/pace/pace.min.js"></script>
    <script id="hexo-configurations">
        var NexT = window.NexT ||
        {};
        var CONFIG = {
            "hostname": "paynewu.com",
            "root": "/",
            "scheme": "Pisces",
            "version": "7.8.0",
            "exturl": false,
            "sidebar":
            {
                "position": "right",
                "width": 320,
                "display": "post",
                "padding": 18,
                "offset": 12,
                "onmobile": false
            },
            "copycode":
            {
                "enable": true,
                "show_result": true,
                "style": "mac"
            },
            "back2top":
            {
                "enable": true,
                "sidebar": false,
                "scrollpercent": true
            },
            "bookmark":
            {
                "enable": false,
                "color": "#222",
                "save": "auto"
            },
            "fancybox": false,
            "mediumzoom": false,
            "lazyload": false,
            "pangu": true,
            "comments":
            {
                "style": "tabs",
                "active": "valine",
                "storage": true,
                "lazyload": false,
                "nav": null,
                "activeClass": "valine"
            },
            "algolia":
            {
                "hits":
                {
                    "per_page": 10
                },
                "labels":
                {
                    "input_placeholder": "Search for Posts",
                    "hits_empty": "We didn't find any results for the search: ${query}",
                    "hits_stats": "${hits} results found in ${time} ms"
                }
            },
            "localsearch":
            {
                "enable": true,
                "trigger": "auto",
                "top_n_per_article": 8,
                "unescape": false,
                "preload": false
            },
            "motion":
            {
                "enable": false,
                "async": false,
                "transition":
                {
                    "post_block": "bounceDownIn",
                    "post_header": "slideDownIn",
                    "post_body": "slideDownIn",
                    "coll_header": "slideLeftIn",
                    "sidebar": "slideUpIn"
                }
            },
            "path": "search.xml"
        };

    </script>
    <meta name="description" content="Talk is free，please state clearly">
    <meta property="og:type" content="website">
    <meta property="og:title" content="吴志鹏｜Payne-Wu">
    <meta property="og:url" content="https://paynewu.com/">
    <meta property="og:site_name" content="吴志鹏｜Payne-Wu">
    <meta property="og:description" content="Talk is free，please state clearly">
    <meta property="og:locale" content="zh_CN">
    <meta property="article:author" content="吴志鹏">
    <meta property="article:tag" content="吴志鹏">
    <meta property="article:tag" content="Payne">
    <meta property="article:tag" content="payne-wu">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Java">
    <meta property="article:tag" content="Golang">
    <meta property="article:tag" content="go">
    <meta property="article:tag" content="spider">
    <meta property="article:tag" content="crawler">
    <meta property="article:tag" content="js">
    <meta property="article:tag" content="爬虫">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="docker">
    <meta name="twitter:card" content="summary">
    <link rel="canonical" href="https://paynewu.com/">
    <script id="page-configurations">
        // https://hexo.io/docs/variables.html
        CONFIG.page = {
            sidebar: "",
            isHome: true,
            isPost: false,
            lang: 'zh-CN'
        };

    </script>
    <title>吴志鹏｜Payne-Wu</title>
    <meta name="google-site-verification" content="p_bIcnvirkFzG2dYKuNDivKD8-STet5W7D-01woA2fc" />
    <noscript>
        <style>
            .use-motion .brand,
            .use-motion .menu-item,
            .sidebar-inner,
            .use-motion .post-block,
            .use-motion .pagination,
            .use-motion .comments,
            .use-motion .post-header,
            .use-motion .post-body,
            .use-motion .collection-header
            {
                opacity: initial;
            }

            .use-motion .site-title,
            .use-motion .site-subtitle
            {
                opacity: initial;
                top: initial;
            }

            .use-motion .logo-line-before i
            {
                left: initial;
            }

            .use-motion .logo-line-after i
            {
                right: initial;
            }

        </style>
    </noscript>
    <link rel="alternate" href="/atom.xml" title="吴志鹏｜Payne-Wu" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
    <div class="container">
        <div class="headband"></div>
        <header class="header" itemscope itemtype="http://schema.org/WPHeader">
            <div class="header-inner">
                <div class="site-brand-container">
                    <div class="site-nav-toggle">
                        <div class="toggle" aria-label="切换导航栏">
                            <span class="toggle-line toggle-line-first"></span>
                            <span class="toggle-line toggle-line-middle"></span>
                            <span class="toggle-line toggle-line-last"></span>
                        </div>
                    </div>
                    <div class="site-meta">
                        <a href="/" class="brand" rel="start">
                            <span class="logo-line-before"><i></i></span>
                            <h1 class="site-title">吴志鹏｜Payne-Wu </h1>
                            <span class="logo-line-after"><i></i></span>
                        </a>
                    </div>
                    <div class="site-nav-right">
                        <div class="toggle popup-trigger">
                            <i class="fa fa-search fa-fw fa-lg"></i>
                        </div>
                    </div>
                </div>
                <nav class="site-nav">
                    <ul id="menu" class="main-menu menu">
                        <li class="menu-item menu-item-home">
                            <a href="/" rel="section">首页</a>
                        </li>
                        <li class="menu-item menu-item-archives">
                            <a href="/archives/" rel="section">文章列表</a>
                        </li>
                        <li class="menu-item menu-item-tags">
                            <a href="/tags/" rel="section">文章标签</a>
                        </li>
                        <li class="menu-item menu-item-categories">
                            <a href="/categories/" rel="section">文章集合</a>
                        </li>
                        <li class="menu-item menu-item-about">
                            <a href="/about/" rel="section">关于我</a>
                        </li>
                        <li class="menu-item menu-item-message">
                            <a href="/message/" rel="section">留言与我</a>
                        </li>
                        <li class="menu-item menu-item-search">
                            <a role="button" class="popup-trigger">搜索 </a>
                        </li>
                    </ul>
                </nav>
                <div class="search-pop-overlay">
                    <div class="popup search-popup">
                        <div class="search-header">
                            <span class="search-icon">
                                <i class="fa fa-search"></i>
                            </span>
                            <div class="search-input-container">
                                <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
                            </div>
                            <span class="popup-btn-close">
                                <i class="fa fa-times-circle"></i>
                            </span>
                        </div>
                        <div id="search-result">
                            <div id="no-result">
                                <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <div class="back-to-top">
            <i class="fa fa-arrow-up"></i>
            <span>0%</span>
        </div>
        <a href="https://github.com/Payne-Wu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true">
                <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
                <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
                <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path>
            </svg></a>
        <main class="main">
            <div class="main-inner">
                <div class="content-wrap">
                    <div class="content index posts-expand">
                        <div class="carousel">
                            <div id="wowslider-container">
                                <div class="ws_images">
                                    <ul>
                                    </ul>
                                </div>
                                <div class="ws_thumbs">
                                    <div>
                                    </div>
                                </div>
                                <div class="ws_shadow"></div>
                            </div>
                        </div>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/1135024868.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> 数据库 <i class="label-arrow"></i>
                                    </a>
                                    <a href="/1135024868.html" class="post-title-link" itemprop="url">MySQL索引</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="什么是索引"><a href="#什么是索引" class="headerlink" title="什么是索引"></a>什么是索引</h2>
                                    <blockquote>
                                        <p>索引：可简单理解为一本书的目录的集合</p>
                                    </blockquote>
                                    <p>​ 索引（在MySQL中也叫<strong>键（key）</strong>）是存储引擎用于快速查找记录的一种数据结构。索引对于性能拥有至关重要的地位。尤其是当表中的数据量越来越大，索引对于性能的影响愈发重要。反之不恰当的索引对于性能也会急剧下降。</p>
                                    <p><strong>索引是一把双刃剑</strong></p>
                                    <h2 id="索引的优与劣"><a href="#索引的优与劣" class="headerlink" title="索引的优与劣"></a>索引的优与劣</h2>
                                    <h3 id="索引的优点"><a href="#索引的优点" class="headerlink" title="索引的优点"></a>索引的优点</h3>
                                    <ul>
                                        <li>大大减少扫描数据量</li>
                                        <li>帮助服务器避免排序和临时表</li>
                                        <li>将随机I/O变为顺序I/O</li>
                                        <li>可以大大加快数据的检索速度，这也是创建索引的最主要的用途。</li>
                                        <li>通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能。</li>
                                    </ul>
                                    <h3 id="索引的缺点"><a href="#索引的缺点" class="headerlink" title="索引的缺点"></a>索引的缺点</h3>
                                    <p><strong>时间方面</strong></p>
                                    <p>创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增加</p>
                                    <p><strong>空间方面</strong></p>
                                    <p>索引需要占物理空间，如果要建立聚簇索引，那么需要的空间就会更大</p>
                                    <p>当对表中的数据进行增加、删除、修改的时索引也要动态的维护，这样就降低了数据的维护速度。</p>
                                    <p><strong>应用方面</strong></p>
                                    <p>锁竞争</p>
                                    <h2 id="索引的类型"><a href="#索引的类型" class="headerlink" title="索引的类型"></a>索引的类型</h2>
                                    <p>索引有很多种类，可以为不同场景提供更好的性能。索引在存储引擎层实现的，故并没有<strong>统一的</strong>索引标准</p>
                                    <blockquote>
                                        <p>不同的存储引擎的索引工作方式也不尽相同</p>
                                    </blockquote>
                                    <h3 id="索引的种类"><a href="#索引的种类" class="headerlink" title="索引的种类"></a>索引的种类</h3>
                                    <h4 id="物理顺序与键值的索引逻辑顺序关系"><a href="#物理顺序与键值的索引逻辑顺序关系" class="headerlink" title="物理顺序与键值的索引逻辑顺序关系"></a>物理顺序与键值的索引逻辑顺序关系</h4>
                                    <p>聚集索引：数据行的物理顺序与列值（一般是主键的那一列）的逻辑顺序相同，一个表中只能拥有<strong>一个聚集索引</strong>。</p>
                                    <p>非聚集索引：逻辑顺序与磁盘上行的物理存储顺序不同，一个表中可以拥有<strong>多个非聚集索引</strong>。</p>
                                    <p><strong>聚簇索引与非聚簇索引异同</strong></p>
                                    <p>在 InnoDB 里，索引B+ Tree的叶子节点存储了整行数据的是主键索引，也被称之为聚簇索引，即将数据存储与索引放到了一块，找到索引也就找到了数据。</p>
                                    <p>而索引B+ Tree的叶子节点存储了主键的值的是非主键索引，也被称之为非聚簇索引、二级索引。</p>
                                    <p>聚簇索引与非聚簇索引的区别：</p>
                                    <ul>
                                        <li>非聚集索引与聚集索引的区别在于非聚集索引的叶子节点不存储表中的数据，而是存储该列对应的主键（行号）</li>
                                        <li>对于InnoDB来说，想要查找数据我们还需要根据主键再去聚集索引中进行查找，这个再根据聚集索引查找数据的过程，我们称为<strong>回表</strong>。第一次索引一般是顺序IO，回表的操作属于随机IO。需要回表的次数越多，即随机IO次数越多，我们就越倾向于使用全表扫描 。</li>
                                        <li>通常情况下， 主键索引（聚簇索引）查询只会查一次，而非主键索引（非聚簇索引）需要回表查询多次。当然，如果是覆盖索引的话，查一次即可</li>
                                    </ul>
                                    <p>注意：MyISAM无论主键索引还是二级索引都是非聚簇索引，而InnoDB的主键索引是聚簇索引，二级索引是非聚簇索引。我们自己建的索引基本都是非聚簇索引。</p>
                                    <h4 id="存储结构"><a href="#存储结构" class="headerlink" title="存储结构"></a>存储结构</h4>
                                    <blockquote>
                                        <p>这里所描述的是索引存储时保存的形式</p>
                                    </blockquote>
                                    <ul>
                                        <li>
                                            <p>B Tree索引（B-Tree或B+Tree索引）BTREE索引就是一种将索引值按一定的算法，存入一个树形的数据结构中（二叉树），每次查询都是从树的入口root开始，依次遍历node，获取leaf。这是<strong>MySQL里默认和最常用的索引类型。</strong></p>
                                        </li>
                                        <li>
                                            <p>Hash索引，HASH索引可以一次定位，不需要像树形索引那样逐层查找,因此具有极高的效率。但是，这种高效是有条件的，即只在“=”和“in”条件下高效，对于范围查询、排序及组合索引仍然效率不高</p>
                                        </li>
                                        <li>
                                            <p>full index 全文索引，其可以在CREATE TABLE ，ALTER TABLE ，CREATE INDEX 使用，不过只有 CHAR、VARCHAR ，TEXT 列上可以创建全文索引</p>
                                        </li>
                                        <li>
                                            <p>R-Tree索引。RTREE在MySQL很少使用，<strong>仅支持geometry数据类型</strong>，相对于BTREE，RTREE的优势在于范围查找。</p>
                                        </li>
                                    </ul>
                                    <h5 id="B-Tree-索引"><a href="#B-Tree-索引" class="headerlink" title="B Tree 索引"></a>B Tree 索引</h5>
                                    <p>通常意味着所有的值都是顺序存储的，并且每个叶子页到根的距离相同</p>
                                    <p><strong>适用范围</strong></p>
                                    <p>全键值、键值范围、前缀查找</p>
                                    <p><strong>应用场景</strong></p>
                                    <p>全值匹配、匹配最左前缀、匹配列前缀、匹配范围值、精确匹配某一列并范围匹配另一列、值访问索引的查询</p>
                                    <p><strong>限制</strong></p>
                                    <ul>
                                        <li>必须为最左开始，否则不使用索引</li>
                                        <li>无法跳跃查询索引中的列</li>
                                        <li>范围查询影响，右边的无法使用索引</li>
                                    </ul>
                                    <h5 id="Hash-索引"><a href="#Hash-索引" class="headerlink" title="Hash 索引"></a>Hash 索引</h5>
                                    <p>基于Hash表实现，只有<strong>精确匹配</strong>索引<strong>所有列</strong>的查询<strong>才有效</strong></p>
                                    <p>对于每一行数据存储引擎都会对所有的索引计算一个hash code。hash code 较小的值，并且不同键值的行计算出来的hash code页不一样。hash索引将所有的hash code存储在索引中，同时在hash table中保存指向每个数据的指针</p>
                                    <p><strong>hash索引查询步骤</strong></p>
                                    <ol>
                                        <li>先计算数据的hashcode，并使用该值查找对应的记录指针</li>
                                        <li>查找在hash table中的指向</li>
                                        <li>值比较确认</li>
                                    </ol>
                                    <p><strong>特点</strong></p>
                                    <p>因为索引自身只需要存储对应的hash code，所有索引结构<strong>非常紧凑</strong>，这也让hash索引查找速度非常快</p>
                                    <p><strong>限制</strong></p>
                                    <ul>
                                        <li>
                                            <p>hash index 只包含hash值和行指针，而不存储字段值，所以不能使用hash index来避免读取行。同时访问内存中的数据速度非常快，所以对于大部分情况下这一点对于性能影响并不明显</p>
                                        </li>
                                        <li>
                                            <p>hash index数据并不是按照索引顺序存储的，所以无法用于排序</p>
                                        </li>
                                        <li>hash index 也不支持部分索引列匹配查找</li>
                                        <li>hash index 只支持<strong>等值比较</strong>查询，包括=、IN、&lt;=、=&gt;。也不支持任何范围查询</li>
                                        <li>hash index访问数据非常快，除非有很多hash冲突。同时hash冲突很多，索引维护代价较高昂</li>
                                    </ul>
                                    <h5 id="R-Tree索引"><a href="#R-Tree索引" class="headerlink" title="R Tree索引"></a>R Tree索引</h5>
                                    <blockquote>
                                        <p>空间数据索引</p>
                                    </blockquote>
                                    <p>这类索引无需前缀查询，空间索引将会从所有的维度来进行索引数据</p>
                                    <h5 id="full-index"><a href="#full-index" class="headerlink" title="full index"></a>full index</h5>
                                    <blockquote>
                                        <p>全文索引</p>
                                    </blockquote>
                                    <p>全文索引是一种特殊类型的索引，它查找的是文本中的关键词，而非比较索引中的值</p>
                                    <p>全文搜索和其他几种类型的索引的匹配方式完全不同，如停用词、词干、复数、布尔搜索等</p>
                                    <p>全文索引更类似于搜索引擎所做的事情，而不是简单的where条件匹配，而是MATCH AGAINST操作。支持Char、VARCHAR、TEXT类型、自然语言搜索、bool搜索</p>
                                    <h4 id="应用层次"><a href="#应用层次" class="headerlink" title="应用层次"></a>应用层次</h4>
                                    <ul>
                                        <li>主键索引： 加速查询 + 列值唯一（不可以有null）+ 表中只有一个</li>
                                        <li>
                                            <p>普通索引： 仅加速查询</p>
                                        </li>
                                        <li>
                                            <p>唯一索引: 加速查询 + 列值唯一（可以有null）</p>
                                        </li>
                                        <li>
                                            <p>复合索引: 多列值组成一个索引，专门用于组合搜索，其效率大于索引合并</p>
                                        </li>
                                        <li>全文索引： 对文本的内容进行分词，进行搜索</li>
                                        <li>覆盖索引: select的数据列只用从索引中就能够取得，不必读取数据行，换句话说查询列要被所建的索引覆盖</li>
                                    </ul>
                                    <blockquote>
                                        <p>索引合并，使用多个单列索引组合搜索</p>
                                    </blockquote>
                                    <h2 id="索引创建"><a href="#索引创建" class="headerlink" title="索引创建"></a>索引创建</h2>
                                    <p>正确的创建索引是实现高性能查询的基础</p>
                                    <h3 id="建索引的原则"><a href="#建索引的原则" class="headerlink" title="建索引的原则"></a>建索引的原则</h3>
                                    <blockquote>
                                        <p>为了使索引的使用效率更高，在创建索引时，必须考虑</p>
                                        <ul>
                                            <li>
                                                <p><strong>在哪些字段上创建索引</strong></p>
                                            </li>
                                            <li>
                                                <p><strong>创建什么类型的索引</strong>。</p>
                                            </li>
                                            <li>
                                                <p><strong>索引设计原则</strong></p>
                                            </li>
                                        </ul>
                                    </blockquote>
                                    <ol>
                                        <li>必须要有主键,如果没有可以做为主键条件的列,创建无关列</li>
                                        <li>经常做为where条件列 order by group by join on, distinct 的条件(业务:产品功能+用户行为)</li>
                                        <li>最好使用唯一值多的列作为索引,如果索引列重复值较多,可以考虑使用联合索引</li>
                                        <li>列值长度较长的索引列,建议使用前缀索引.</li>
                                        <li>降低索引条目,一方面不要创建没用索引,不常使用的索引清理,percona toolkit(xxxxx)</li>
                                        <li>索引维护要避开业务繁忙期</li>
                                    </ol>
                                    <p><strong>CREATE TABLE创建索引</strong></p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">CREATE TABLE IF NOT EXISTS &#96;ch_people_msg&#96; ( </span><br><span class="line">  &#96;p_id&#96;  SERIAL NOT NULL AUTO_INCREMENT COMMENT &#39;用户id&#39; , </span><br><span class="line">  &#96;p_uic&#96; CHAR(18) NOT NULL COMMENT &#39;用户身份证&#39;,</span><br><span class="line">  &#96;p_nickname&#96; VARCHAR(50) NOT NULL COMMENT &#39;用户昵称&#39;, </span><br><span class="line">  &#96;p_gender&#96; ENUM(&#39;m&#39;,&#39;f&#39;, &#39;n&#39;) NOT NULL DEFAULT &#39;n&#39; COMMENT &#39;用户性别&#39;, </span><br><span class="line">  &#96;p_age&#96; TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT &#39;用户年龄&#39;, </span><br><span class="line">  &#96;p_pnum&#96; CHAR(11) NOT NULL COMMENT &#39;用户电话&#39;, </span><br><span class="line">  &#96;p_address&#96; VARCHAR(100) NOT NULL COMMENT &#39;用户地址&#39;, </span><br><span class="line">  &#96;p_email&#96; VARCHAR(50) NOT NULL COMMENT &#39;用户邮箱&#39;, </span><br><span class="line">  &#96;p_add_time&#96; TIMESTAMP NOT NULL DEFAULT NOW() COMMENT &#39;统计用户时间&#39;,</span><br><span class="line">   PRIMARY KEY (&#96;p_id&#96;),</span><br><span class="line">   UNIQUE KEY &#96;p_uic&#96;(&#96;p_uic&#96;)</span><br><span class="line">) ENGINE &#x3D; InnoDB CHARSET&#x3D;utf8mb4 COLLATE utf8mb4_general_ci COMMENT &#x3D; &#39;中国成员信息表&#39;;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>ALTER TABLE命令去增加索引</strong></p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">ALTER TABLE table_name ADD INDEX index_name (column_list);</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="创建索引时注意点"><a href="#创建索引时注意点" class="headerlink" title="创建索引时注意点"></a>创建索引时注意点</h3>
                                    <ul>
                                        <li>非空字段：应该指定列为NOT NULL，除非你想存储NULL。在mysql中，含有空值的列很难进行查询优化，因为它们使得索引、索引的统计信息以及比较运算更加复杂。你应该用0、一个特殊的值或者一个空串代替空值；</li>
                                        <li>取值离散大的字段：（变量各个取值之间的差异程度）的列放到联合索引的前面，可以通过count()函数查看字段的差异值，返回值越大说明字段的唯一值越多字段的离散程度高；</li>
                                        <li>索引字段越小越好：数据库的数据存储以页为单位一页存储的数据越多一次IO操作获取的数据越大效率越高。</li>
                                    </ul>
                                    <h2 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h2>
                                    <p><strong>函数导致的索引失效</strong></p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">SELECT * FROM &#96;user&#96; WHERE DATE(create_time) &#x3D; &#39;2012-11-03&#39;;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>运算符导致的索引失效</strong></p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 如果对列进行了（+，-，*，&#x2F;，!）运算, 那么都将不会走索引。</span><br><span class="line">select p_id from xxx where p_id + 10 &#x3D; 12</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>OR引起的索引失效</strong></p>
                                    <blockquote>
                                        <p>OR导致索引是在特定情况下的，并不是所有的OR都是使索引失效</p>
                                        <p>如果OR连接的是同一个字段，那么索引不会失效，反之索引失效。</p>
                                    </blockquote>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">SELECT * FROM &#96;xxx&#96; WHERE &#96;name&#96; &#x3D; &#39;xxx&#39; OR age &#x3D; 20;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>模糊搜索导致的索引失效</strong></p>
                                    <blockquote>
                                        <p>当模糊查询<code>%</code>在匹配字段前缀不走索引，放在后面才会走索引。</p>
                                    </blockquote>
                                    <p><strong>使用!= 或者 &lt;&gt; 导致索引失效</strong></p>
                                    <p><strong>类型不一致导致的索引失效</strong></p>
                                    <p><strong>NOT IN、NOT EXISTS导致索引失效</strong></p>
                                    <p><strong>避免索引失效总结</strong></p>
                                    <ol>
                                        <li>尽量采用确认的、顺序的、逐步的</li>
                                        <li>模糊查询<code>%</code>不在前</li>
                                        <li>索引列不运算</li>
                                    </ol>
                                    <h2 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h2>
                                    <p>自5.6引入了索引下推优化。默认开启</p>
                                    <blockquote>
                                        <p>可使用<code>SET optimizer_switch = ‘index_condition_pushdown=off;</code>将其关闭。</p>
                                    </blockquote>
                                    <ul>
                                        <li>有了索引下推优化，可以在<strong>减少回表次数</strong></li>
                                        <li>在InnoDB中只针对二级索引有效</li>
                                    </ul>
                                    <p>官方文档中给的例子和解释如下：</p>
                                    <p>在 people_table中有一个二级索引(zipcode，lastname，firstname)，查询是SELECT * FROM people WHERE zipcode=’95054′ AND lastname LIKE ‘%etrunia%’ AND address LIKE ‘%Main Street%’;</p>
                                    <ul>
                                        <li>如果没有使用索引下推技术，则MySQL会通过zipcode=’95054’从存储引擎中查询对应的数据，返回到MySQL服务端，然后MySQL服务端基于lastname LIKE ‘%etrunia%’ and address LIKE ‘%Main Street%’来判断数据是否符合条件</li>
                                        <li>如果使用了索引下推技术，则MYSQL首先会返回符合zipcode=’95054’的索引，然后根据lastname LIKE ‘%etrunia%’ and address LIKE ‘%Main Street%’来判断索引是否符合条件。如果符合条件，则根据该索引来定位对应的数据，如果不符合，则直接reject掉。</li>
                                    </ul>
                                    <h2 id="默认使用B-Tree的优势"><a href="#默认使用B-Tree的优势" class="headerlink" title="默认使用B+Tree的优势"></a>默认使用B+Tree的优势</h2>
                                    <blockquote>
                                        <p>为什么索引结构默认使用B+Tree，而不是B-Tree，Hash，二叉树，红黑树？</p>
                                    </blockquote>
                                    <p>B-tree：</p>
                                    <ul>
                                        <li>B+树的磁盘读写代价更低：B+树的内部节点并没有指向关键字具体信息的指针，因此其内部节点相对B(B-)树更小，如果把所有同一内部节点的关键字存放在同一盘块中，那么盘块所能容纳的关键字数量也越多，一次性读入内存的需要查找的关键字也就越多，相对<code>IO读写次数就降低</code>了。</li>
                                        <li>由于B+树的数据都存储在叶子结点中，分支结点均为索引，方便扫库，只需要扫一遍叶子结点即可，但是B树因为其分支结点同样存储着数据，我们要找到具体的数据，需要进行一次中序遍历按序来扫，所以B+树更加适合在<code>区间查询</code>的情况，所以通常B+树用于数据库索引。</li>
                                    </ul>
                                    <p>Hash：</p>
                                    <ul>
                                        <li>
                                            <p>虽然可以快速定位，但是没有顺序，IO复杂度高；</p>
                                        </li>
                                        <li>
                                            <p>基于Hash表实现，只有Memory存储引擎显式支持哈希索引 ；</p>
                                        </li>
                                        <li>适合<strong>等值查询</strong>，如=、in()、&lt;=&gt;，不支持范围查询 ；</li>
                                        <li>因为不是按照索引值顺序存储的，就不能像B+Tree索引一样利用索引完成排序 ；</li>
                                        <li>Hash索引在查询等值时非常快 ；</li>
                                        <li>因为Hash索引始终索引的<strong>所有列的全部内容</strong>，所以不支持部分索引列的匹配查找 ；</li>
                                        <li>如果有大量重复键值得情况下，哈希索引的效率会很低，因为存在哈希碰撞问题 。</li>
                                    </ul>
                                    <p>二叉树：树的高度不均匀，不能自平衡，查找效率跟数据有关（树的高度），并且IO代价高。</p>
                                    <p>红黑树：树的高度随着数据量增加而增加，IO代价高。</p>
                                    <h2 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h2>
                                    <p>《高性能MySQL》</p>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-09 19:26:41 / 修改时间：23:27:03" itemprop="dateCreated datePublished" datetime="2021-09-09T19:26:41+08:00">2021-09-09</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/1135024868.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/1135024868.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>4.4k</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>4 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/1439700985.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> 数据库 <i class="label-arrow"></i>
                                    </a>
                                    <a href="/1439700985.html" class="post-title-link" itemprop="url">MySQL的安装与配置</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="Linux平台下MySQL的安装"><a href="#Linux平台下MySQL的安装" class="headerlink" title="Linux平台下MySQL的安装"></a>Linux平台下MySQL的安装</h2>
                                    <p>LSB Version: :core-4.1-amd64:core-4.1-noarch</p>
                                    <p>Distributor ID: CentOS</p>
                                    <p>Description: CentOS Linux release 7.9.2009 (Core)</p>
                                    <p>Release: 7.9.2009</p>
                                    <p>Codename: Core</p>
                                    <p>ldd (GNU libc) :2.17</p>
                                    <h3 id="前置工作"><a href="#前置工作" class="headerlink" title="前置工作"></a>前置工作</h3>
                                    <h4 id="删除mariadb"><a href="#删除mariadb" class="headerlink" title="删除mariadb"></a>删除mariadb</h4>
                                    <figure class="highlight routeros">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">yum <span class="builtin-name">remove</span> -y mariadb-libs.x86_64</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h3>
                                    <h4 id="安装rpm"><a href="#安装rpm" class="headerlink" title="安装rpm"></a>安装rpm</h4>
                                    <p>进入MySQL的<a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">yum仓库</a>，如下图所示</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu50sz34orj616r0u079a02.jpg" alt="image-20210904233814767"></p>
                                    <p>官方rpm包: <a href="https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm" target="_blank" rel="noopener">https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</a></p>
                                    <p>清华镜像rpm包: <a href="https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql80-community-el7/mysql80-community-release-el7-3.noarch.rpm" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql80-community-el7/mysql80-community-release-el7-3.noarch.rpm</a></p>
                                    <figure class="highlight llvm">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">wget -<span class="keyword">c</span> rpm地址</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="安装yum仓库文件"><a href="#安装yum仓库文件" class="headerlink" title="安装yum仓库文件"></a>安装yum仓库文件</h4>
                                    <blockquote>
                                        <p>可使用rpm -ivh或是yum localinstall 去安装，两者实质是一样的</p>
                                    </blockquote>
                                    <figure class="highlight css">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="selector-tag">rpm</span> <span class="selector-tag">-ivh</span> <span class="selector-tag">mysql80-community-release-el7-3</span><span class="selector-class">.noarch</span><span class="selector-class">.rpm</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">yum install -y  mysql-community-server</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h3>
                                    <p><a href="https://downloads.mysql.com/archives/community/" target="_blank" rel="noopener">https://downloads.mysql.com/archives/community/</a></p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu5lm5v8toj61aq06wdik02.jpg" alt="image-20210905113818649"></p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># 下</span></span><br><span class="line">wget -c https://downloads.mysql.com/archives/get/p/23/file/mysql-8.0.20-linux-glibc2.12-x86_64.tar.xz</span><br><span class="line">tar zf mysql-8.0.20-linux-glibc2.12-x86_64.tar.xz</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="建立用户与授权"><a href="#建立用户与授权" class="headerlink" title="建立用户与授权"></a>建立用户与授权</h4>
                                    <figure class="highlight awk">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">useradd mysql &amp;&amp; usermod -s <span class="regexp">/sbin/</span>nologin mysql</span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>databases<span class="regexp">/mysql &amp;&amp; chown -R mysql. /</span>opt<span class="regexp">/databases/my</span>sql</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># vim /etc/my.cnf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For advice on how to change settings please see</span></span><br><span class="line"><span class="comment"># http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html</span></span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># Remove leading # and set to the amount of RAM for the most important data</span></span><br><span class="line"><span class="comment"># cache in MySQL. Start at 70% of total RAM for dedicated server, else 10%.</span></span><br><span class="line"><span class="comment"># innodb_buffer_pool_size = 128M</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to turn on a very important data integrity option: logging</span></span><br><span class="line"><span class="comment"># changes to the binary log between backups.</span></span><br><span class="line"><span class="comment"># log_bin</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Remove leading # to set options mainly useful for reporting servers.</span></span><br><span class="line"><span class="comment"># The server defaults are faster for transactions and fast SELECTs.</span></span><br><span class="line"><span class="comment"># Adjust sizes as needed, experiment to find the optimal values.</span></span><br><span class="line"><span class="comment"># join_buffer_size = 128M</span></span><br><span class="line"><span class="comment"># sort_buffer_size = 2M</span></span><br><span class="line"><span class="comment"># read_rnd_buffer_size = 2M</span></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="built_in">log</span>-error=/var/<span class="built_in">log</span>/mysqld.log</span><br><span class="line">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class="line"></span><br><span class="line">default-storage-engine=INNODB</span><br><span class="line">character-set-server = utf8mb4</span><br><span class="line">collation-server = utf8mb4_general_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line">secure_file_priv=<span class="string">''</span></span><br><span class="line">user = mysql</span><br><span class="line">port=8916</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default-character-set=utf8mb4</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="获取初始root密码"><a href="#获取初始root密码" class="headerlink" title="获取初始root密码"></a>获取初始root密码</h3>
                                    <figure class="highlight lasso">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">grep <span class="string">'temporary password'</span> /<span class="built_in">var</span>/<span class="keyword">log</span>/mysqld.<span class="keyword">log</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="创建用户与授权"><a href="#创建用户与授权" class="headerlink" title="创建用户与授权"></a>创建用户与授权</h3>
                                    <p>根据业务、公司情况创建管理员，若公司成员较少，管理员管全局。反之管单库</p>
                                    <blockquote>
                                        <ol>
                                            <li>root不允许远程连接</li>
                                            <li>修改root密码</li>
                                        </ol>
                                    </blockquote>
                                    <h3 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h3>
                                    <p>授权</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">远程登录还需要授权远程登录Mysql默认不允许远程登录，我们需要设置关闭selinux或者防火墙，不关防火墙就开放3306端口；</span><br><span class="line"><span class="comment">#放开3306端口</span></span><br><span class="line">firewall-cmd --zone=public --add-port=3306/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-04 23:29:41" itemprop="dateCreated datePublished" datetime="2021-09-04T23:29:41+08:00">2021-09-04</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/1439700985.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/1439700985.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>589</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>1 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/3847153486.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> blog <i class="label-arrow"></i>
                                    </a>
                                    <a href="/3847153486.html" class="post-title-link" itemprop="url">ssh结合actions实现源码分离部署</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <p>本博客采用github page实现部署，但由于github的性质无法有效的进行分离快速部署。</p>
                                    <p>必须博客展示页，必须以username.github.io结尾，这样感觉不是很方便</p>
                                    <p>部署前基本流程为，部署github page -&gt; 手动上传源码到对应仓库。</p>
                                    <p>那么我们是否可以直接push到私有源码仓库，出发二段部署从实现自动的博客部署，此时我们只需要关心与维护自己的博客源码，再也不用刻意的关注部署了</p>
                                    <p>说干就干</p>
                                    <h2 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h2>
                                    <h3 id="ssh部署"><a href="#ssh部署" class="headerlink" title="ssh部署"></a>ssh部署</h3>
                                    <figure class="highlight excel">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">ssh-keygen -<span class="built_in">t</span> rsa -C <span class="string">"your email"</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>完成后将在本地<code>$HOME/.ssh</code>中生成私钥<code>id_rsa</code>,与公钥，<code>id_rsa.pub</code>,将公钥上传到github上，进入<a href="https://github.com/settings/keys" target="_blank" rel="noopener">https://github.com/settings/keys</a> ，登陆自己的github账号。如下所示</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu4h329orfj60tf0a775a02.jpg" alt="image-20210904121559885"></p>
                                    <p>New SSH Key</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu4h3tn133j60lp0bomxg02.jpg" alt="image-20210904121643113"></p>
                                    <p>其中title为自定义，key为<code>id_rsa.pub</code>中内容。完成后点击Add SSH key即可</p>
                                    <h2 id="建立私有博客源码仓库"><a href="#建立私有博客源码仓库" class="headerlink" title="建立私有博客源码仓库"></a>建立私有博客源码仓库</h2>
                                    <p>github上创建一个私有仓库即可，详细流程不在过多赘述</p>
                                    <h2 id="创建Actions"><a href="#创建Actions" class="headerlink" title="创建Actions"></a>创建Actions</h2>
                                    <h3 id="配置Actions-secrets"><a href="#配置Actions-secrets" class="headerlink" title="配置Actions secrets"></a>配置Actions secrets</h3>
                                    <p>Settings -&gt; Deploy keys -&gt; New repository secrets，如下所示</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu4ezhkflmj61mk0u0aeq02.jpg" alt="image-20210904110320916"></p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu4f2jcgr5j61sv0u00v602.jpg" alt="image-20210904110617453"></p>
                                    <p>将上面生成的id_rsa，复制到私钥中。</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu4hbf985wj6172072wf202.jpg" alt="image-20210904122401191"></p>
                                    <p>将workflow增加到源码文件中，拉取到本地。</p>
                                    <p>deploy.yml如下</p>
                                    <figure class="highlight yaml">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># This is a basic workflow to help you get started with Actions</span></span><br><span class="line"></span><br><span class="line"><span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Github</span> <span class="string">Pages</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Controls when the action will run. Triggers the workflow on push or pull request</span></span><br><span class="line"><span class="comment"># events but only for the master branch</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> <span class="string">[</span> <span class="string">master</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># A workflow run is made up of one or more jobs that can run sequentially or in parallel</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="comment"># This workflow contains a single job called "build"</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="comment"># The type of runner that the job will run on</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Steps represent a sequence of tasks that will be executed as part of the job</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="comment"># Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Env</span> <span class="string">setup</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">mkdir</span> <span class="string">-p</span> <span class="string">~/.ssh/</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">"$<span class="template-variable">&#123;&#123; secrets.DEPLOY_KEY &#125;&#125;</span>"</span> <span class="string">&gt;</span> <span class="string">~/.ssh/id_rsa</span>	<span class="comment"># DEPLOY_KEY 为secret name</span></span><br><span class="line">          <span class="string">chmod</span> <span class="number">600</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line">          <span class="string">ssh-keyscan</span> <span class="string">-t</span> <span class="string">rsa</span> <span class="string">github.com</span> <span class="string">&gt;&gt;</span> <span class="string">~/.ssh/known_hosts</span></span><br><span class="line">          <span class="comment"># setup deploy git account</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">"your user name"</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">"your email"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">find</span> <span class="string">.</span> <span class="string">-type</span> <span class="string">f</span> <span class="string">-name</span> <span class="string">*.log</span> <span class="string">-delete</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">run</span> <span class="string">clean</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line">          <span class="string">npm</span> <span class="string">run</span> <span class="string">deploy</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
                                    <p>以上便是github page 源码保护分析详细过程，其基本原理就是将ssh部署的工作交给自动构建的Actions。</p>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-04 13:37:41" itemprop="dateCreated datePublished" datetime="2021-09-04T13:37:41+08:00">2021-09-04</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/3847153486.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/3847153486.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>605</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>1 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/507251385.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> 数据库 <i class="label-arrow"></i>
                                    </a>
                                    <a href="/507251385.html" class="post-title-link" itemprop="url">MySQL优化</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <p>mysql优化老生常谈了，但却也离不开业务。脱离业务来讲mysql可以从两个方面进行优化</p>
                                    <ul>
                                        <li>
                                            <p>安全优化（业务持续性）</p>
                                        </li>
                                        <li>
                                            <p>性能优化（业务高效性）</p>
                                        </li>
                                    </ul>
                                    <p>所谓优化，个人认为有两大需要提前知道的<strong>稳定性和业务可持续性通常比性能更重要</strong>，<strong>优化是由业务需要驱使的</strong></p>
                                    <p>通常优化也与操作系统、运行环境等息息相关，结合业务适合自己才是最好的。</p>
                                    <h2 id="安全优化"><a href="#安全优化" class="headerlink" title="安全优化"></a>安全优化</h2>
                                    <p>足够强度的安全是保证业务正常运行的基石，安全优化通常可以以系统安全，应用程序安全，与sql安全。</p>
                                    <h3 id="系统安全"><a href="#系统安全" class="headerlink" title="系统安全"></a>系统安全</h3>
                                    <blockquote>
                                        <p>具体详情请参考Linux系统安全</p>
                                    </blockquote>
                                    <p><strong>物理安全</strong></p>
                                    <p>物理环境安全，小微企业一般使用云服务器，大型企业一般有多个机房，实现异地多活</p>
                                    <p><strong>防火墙策略、关闭或切换不必要的端口</strong></p>
                                    <blockquote>
                                        <ol>
                                            <li>修改常见应用默认端口，22、3306、27017、6379等</li>
                                        </ol>
                                    </blockquote>
                                    <p><strong>账户安全</strong></p>
                                    <p>用户连接权限、用户权限</p>
                                    <blockquote>
                                        <ol>
                                            <li>禁止root远程</li>
                                            <li>账号管理（密码强度、用户权限）</li>
                                        </ol>
                                    </blockquote>
                                    <p><strong>源代码文件目录权限管理</strong></p>
                                    <p><strong>备份</strong>等</p>
                                    <h3 id="MySQL安全"><a href="#MySQL安全" class="headerlink" title="MySQL安全"></a>MySQL安全</h3>
                                    <blockquote>
                                        <p><a href="https://www.cnblogs.com/doublexi/p/9732274.html" target="_blank" rel="noopener">https://www.cnblogs.com/doublexi/p/9732274.html</a></p>
                                    </blockquote>
                                    <p>MySQL版本的选择</p>
                                    <p>MySQL的命名机制使用由3个数字和一个后缀组成的版本号。例如，像mysql-5.0.9-beta的版本号这样解释：</p>
                                    <p>数字(5)是主版本号，描述了文件格式。所有版本5的发行都有相同的文件格式。</p>
                                    <p>数字(0)是发行级别。主版本号和发行级别组合到一起便构成了发行序列号。</p>
                                    <p>数字(9)是在此发行系列的版本号，随每个新分发版递增。通常你需要已经选择的发行(release)的最新版本(版本)。</p>
                                    <p>每次更新后，版本字符串的最后一个数字递增。如果相对于前一个版本增加了新功能或有微小的不兼容性，字符串的第二个数字递增。如果文件格式改变，第一个数字递增。</p>
                                    <p>后缀显示发行的稳定性级别。通过一系列后缀显示如何改进稳定性。可能的后缀有：</p>
                                    <p><strong>·alpha表明发行包含大量未被彻底测试的新代码</strong>。已知的缺陷应该在新闻小节被记录。请参见附录D：MySQL变更史。在大多数alpha版本中也有新的命令和扩展。alpha版本也可能有主要代码更改等开发。但我们在发布前一定对其进行测试。</p>
                                    <p><strong>·beta意味着该版本功能是完整的</strong>，并且所有的新代码被测试了，没有增加重要的新特征，应该没有已知的缺陷。当alpha版本至少一个月没有出现报导的致命漏洞，并且没有计划增加导致已经实施的功能不稳定的新功能时，版本则从alpha版变为beta版。</p>
                                    <p>在以后的beta版、发布版或产品发布中，所有API、外部可视结构和SQL命令列均不再更改。</p>
                                    <p><strong>·rc是发布代表</strong>；是一个发行了一段时间的beta版本，看起来应该运行正常。只增加了很小的修复。(发布代表即以前所称的gamma版)</p>
                                    <p>·如果没有后缀，这意味着该版本已经在很多地方运行一段时间了，而且没有非平台特定的缺陷报告。只增加了关键漏洞修复修复。这就是我们称为一个产品(稳定)或“通用”版本的东西。</p>
                                    <p>MySQL的命名机制于其它产品稍有不同。一般情况，我们可以很放心地使用已经投放市场两周而没有被相同发布系列的新版本所代替的版本。</p>
                                    <ul>
                                        <li>稳定不要最新：最新GA版超过10个月或比最新GA版晚3、4个版本的GA版。</li>
                                        <li>前后无大BUG：要选择前后几个月没有<strong>大的BUG修复的版本</strong>，而不是大量<strong>修复BUG的集中版本</strong>。</li>
                                        <li>向后少更新：最好向后较长时间没有更新发布的版本，<strong>若目标版本修复的BUG巨多，向前推进一个版本号。</strong></li>
                                        <li>兼容开发：验证功能瓶颈、性能瓶颈，要考虑开发人员开发程序使用的版本是否兼容你选的版本</li>
                                        <li>测试先行：作为内部开发测试数据库环境，跑大概3-6个月的时间。</li>
                                        <li>非核心先行：优先企业非核心业务采用新版本的数据库GA版本软件。</li>
                                    </ul>
                                    <h4 id="用户安全"><a href="#用户安全" class="headerlink" title="用户安全"></a>用户安全</h4>
                                    <p><strong>禁止root账户远程访问</strong></p>
                                    <p>root权限太高，拥有安全隐患，root只允许本地登陆</p>
                                    <p><strong>mysql用户登录shell为nologin</strong></p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">usermod -s /sbin/nologin mysql</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>对MySQL运行用户降权，以普通用户身份运行MySQL</strong></p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">user=mysql</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>删除匿名账号和空口令账号</strong></p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># 删除空密码用户</span></span><br><span class="line">delete from mysql.user <span class="built_in">where</span> user is NULL or Password IS NULL;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>用户与权限管理</strong></p>
                                    <p>遵循权限最小化原则。</p>
                                    <h4 id="连接安全"><a href="#连接安全" class="headerlink" title="连接安全"></a>连接安全</h4>
                                    <p>修改默认端口</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=8912</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="容灾"><a href="#容灾" class="headerlink" title="容灾"></a>容灾</h4>
                                    <p>在误删除数据的情况下，可以通过二进制日志恢复到某个时间点</p>
                                    <h4 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h4>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 查看bin log（sql）</span><br><span class="line">show variables like &#39;%log_bin%&#39;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu5zib6numj60p40ag75902.jpg" alt="image-20210905193857001"></p>
                                    <p>修改MySQL配置文件my.cnf，加入如下两行</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">server-id = 1</span><br><span class="line">log_bin = /data/mysql/mysql-bin</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>重启服务</p>
                                    <h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">效果 sql与索引优化&gt;Schema设计&gt;数据库实例优化&gt;文件系统&gt;操作系统&gt;硬件优化</span><br><span class="line">成本 硬件优化&gt;操作系统&gt;文件系统&gt;数据库实例优化&gt;Schema设计&gt;sql与索引优化</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="硬件优化"><a href="#硬件优化" class="headerlink" title="硬件优化"></a>硬件优化</h3>
                                    <h4 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h4>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">真实的硬件（PC Server）: DELL  R系列 ，华为，浪潮，HP，联想</span><br><span class="line">云产品：ECS、数据库RDS、DRDS</span><br><span class="line">IBM 小型机 P6  570  595   P7 720  750 780     P8</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4>
                                    <blockquote>
                                        <p>根据业务场景选择</p>
                                    </blockquote>
                                    <p>OLTP \ OLAP<br>IO密集型：线上系统，OLTP主要是IO密集型的业务，高并发<br>CPU密集型：数据分析数据处理，OLAP，cpu密集型的，需要CPU高计算能力（i系列，IBM power系列）<br>CPU密集型： I 系列的，主频很高，核心少<br>IO密集型： E系列（至强），主频相对低，核心数量多</p>
                                    <h4 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h4>
                                    <p>建议2-3倍cpu核心数量 （ECC）</p>
                                    <h4 id="磁盘选择"><a href="#磁盘选择" class="headerlink" title="磁盘选择"></a>磁盘选择</h4>
                                    <p>SATA-III SAS Fc SSD（sata） pci-e ssd Flash<br>主机 RAID卡的BBU(Battery Backup Unit)关闭</p>
                                    <h4 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h4>
                                    <p>根据存储数据种类的不同，选择不同的存储设备<br>配置合理的RAID级别(raid5、raid10、热备盘)<br>r0 :条带化 ,性能高<br>r1 :镜像，安全<br>r5 :校验+条带化，安全较高+性能较高（读），写性能较低 （适合于读多写少）<br>r10：安全+性能都很高，最少四块盘，浪费一半的空间（高IO要求）</p>
                                    <h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4>
                                    <p>1、硬件买好的（单卡单口）<br>2、网卡绑定（bonding），交换机堆叠<br>以上问题，提前规避掉。</p>
                                    <h3 id="操作系统优化"><a href="#操作系统优化" class="headerlink" title="操作系统优化"></a>操作系统优化</h3>
                                    <h4 id="Swap调整"><a href="#Swap调整" class="headerlink" title="Swap调整"></a>Swap调整</h4>
                                    <figure class="highlight vim">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">echo</span> <span class="number">0</span> &gt;/proc/sys/<span class="keyword">vm</span>/swappiness的内容改成<span class="number">0</span>（临时），</span><br><span class="line">/etc/sysctl.<span class="keyword">conf</span></span><br><span class="line">上添加<span class="keyword">vm</span>.swappiness=<span class="number">0</span>（永久）</span><br><span class="line">sysctl -<span class="keyword">p</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>此参数决定了Linux是倾向于使用swap，还是倾向于释放文件系统cache。在内存紧张的情况下，数值越低越倾向于释放文件系统cache。<br>当然，这个参数只能减少使用swap的概率，并不能避免Linux使用swap。</p>
                                    <p>修改MySQL的配置参数innodb_flush_method，开启O_DIRECT模式<br>这种情况下，InnoDB的buffer pool会直接绕过文件系统cache来访问磁盘，但是redo log依旧会使用文件系统cache。值得注意的是，Redo log是覆写模式的，即使使用了文件系统的cache，也不会占用太多</p>
                                    <h4 id="IO调度策略"><a href="#IO调度策略" class="headerlink" title="IO调度策略"></a>IO调度策略</h4>
                                    <p>raid、no lvm、ext4或xfs、ssd、IO调度策略</p>
                                    <h3 id="数据库实例优化"><a href="#数据库实例优化" class="headerlink" title="数据库实例优化"></a>数据库实例优化</h3>
                                    <p>查看系统配置</p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">show variables like “xxx”</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>查看状态</p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">show</span> <span class="keyword">status</span> <span class="keyword">like</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h4>
                                    <h5 id="max-connect-errors"><a href="#max-connect-errors" class="headerlink" title="max_connect_errors"></a><strong>max_connect_errors</strong></h5>
                                    <p> max_connect_errors是一个mysql中与安全有关的计数器值，它负责阻止过多尝试失败的客户端以防止暴力破解密码等情况，当超过指定次数，mysql服务器将禁连接请求，</p>
                                    <p>直到mysql服务器重启或通过flush hosts命令清空此host的相关信息 max_connect_errors的值与性能并无太大关系。</p>
                                    <figure class="highlight jboss-cli">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">修改<span class="string">/etc/my.cnf</span>文件，在[mysqld]下面添加如下内容</span><br><span class="line">max_<span class="keyword">connect</span>_errors=1000</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="Max-connections"><a href="#Max-connections" class="headerlink" title="Max_connections"></a><strong>Max_connections</strong></h5>
                                    <blockquote>
                                        <p>Mysql的最大连接数，如果服务器的并发请求量比较大，可以调高这个值，当然这是要建立在机器能够支撑的情况下，因为如果连接数越来越多，mysql会为每个连接提供缓冲区，就会开销的越多的内存，所以需要适当的调整该值，不能随便去提高设值</p>
                                    </blockquote>
                                    <p>开启数据库时,临时设置一个比较大的测试值, 观察show status like ‘Max_used_connections’;变化<br>如果max_used_connections跟max_connections相同,那么就是max_connections设置过低或者超过服务器的负载上限了，低于10%则设置过大. </p>
                                    <h5 id="back-log"><a href="#back-log" class="headerlink" title="back_log"></a><strong>back_log</strong></h5>
                                    <blockquote>
                                        <p> mysql能暂存的连接数量，当主要mysql线程在一个很短时间内得到非常多的连接请求时候它就会起作用，如果mysql的连接数据达到max_connections时候，新来的请求将会被存在堆栈中，等待某一连接释放资源，该推栈的数量及back_log,如果等待连接的数量超过back_log，将不被授予连接资源。<br>back_log值指出在mysql暂时停止回答新请求之前的短时间内有多少个请求可以被存在推栈中，只有如果期望在一个短时间内有很多连接的时候需要增加它</p>
                                    </blockquote>
                                    <p><u><em>判断依据</em></u></p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">show full processlist</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>发现大量的待连接进程时，就需要加大back_log或者加大max_connections的值</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># vim /etc/my.cnf </span></span><br><span class="line">back_log=xxx</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="wait-timeout"><a href="#wait-timeout" class="headerlink" title="wait_timeout"></a><strong>wait_timeout</strong></h5>
                                    <blockquote>
                                        <p>wait_timeout：指的是mysql在关闭一个非交互的连接之前所要等待的秒数，如果设置太小，那么连接关闭的就很快，从而使一些持久的连接不起作用。长连接的应用，为了不去反复的回收和分配资源，降低额外的开销。</p>
                                    </blockquote>
                                    <p>如果设置太大，容易造成连接打开时间过长，在show processlist时候，能看到很多的连接 ，一般希望wait_timeout尽可能低</p>
                                    <p><strong>interactive_timeout</strong></p>
                                    <blockquote>
                                        <p> 如果设置太大，容易造成连接打开时间过长造成资源损耗，在show processlist时候，能看到很多的连接 ，一般希望wait_timeout尽可能低</p>
                                    </blockquote>
                                    <p>关闭一个交互的连接之前所需要等待的秒数，比如我们在终端上进行mysql管理，使用的即使交互的连接，这时候，如果没有操作的时间超过了interactive_time设置的时间就会自动的断开，默认的是28800，可调优为7200</p>
                                    <h5 id="key-buffer-size"><a href="#key-buffer-size" class="headerlink" title="key_buffer_size"></a>key_buffer_size</h5>
                                    <p>key_buffer_size指定索引缓冲区的大小，它决定索引处理的速度，尤其是索引读的速度</p>
                                    <figure class="highlight dart">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">临时表的创建有关（多表链接、子查询中、union）</span><br><span class="line">     在有以上查询语句出现的时候，需要创建临时表，用完之后会被丢弃</span><br><span class="line">     临时表有两种创建方式：</span><br><span class="line">                        内存中-------&gt;key_buffer_size</span><br><span class="line">                        磁盘上-------&gt;ibdata1(<span class="number">5.6</span>)</span><br><span class="line">                                      ibtmp1 (<span class="number">5.7</span>）</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h4>
                                    <h5 id="sort-buffer-size"><a href="#sort-buffer-size" class="headerlink" title="sort_buffer_size"></a>sort_buffer_size</h5>
                                    <blockquote>
                                        <p>每个需要进行排序的线程分配该大小的一个缓冲区。增加这值加速</p>
                                    </blockquote>
                                    <figure class="highlight crystal">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">ORDER BY </span><br><span class="line">GROUP BY</span><br><span class="line">distinct</span><br><span class="line"><span class="class"><span class="keyword">union</span></span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>Sort_Buffer_Size并不是越大越好，由于是connection级的参数，过大的设置+高并发可能会耗尽系统内存资源。<br>列如：500个连接将会消耗500*sort_buffer_size（2M）=1G内存</p>
                                    <p><strong>配置方法</strong><br>修改/etc/my.cnf文件，在[mysqld]下面添加如下：<br>sort_buffer_size=1M</p>
                                    <h5 id="max-allowed-packet"><a href="#max-allowed-packet" class="headerlink" title="max_allowed_packet"></a>max_allowed_packet</h5>
                                    <blockquote>
                                        <p>mysql根据配置文件会限制，server接受的数据包大小</p>
                                    </blockquote>
                                    <p>有时候大的插入和更新会受max_allowed_packet参数限制，导致写入或者更新失败，更大值是1GB，必须设置1024的倍数</p>
                                    <figure class="highlight ini">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="attr">max_allowed_packet</span>=<span class="number">32</span>M</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="join-buffer-size"><a href="#join-buffer-size" class="headerlink" title="join_buffer_size"></a>join_buffer_size</h5>
                                    <p>用于表间关联缓存的大小，和sort_buffer_size一样，该参数对应的分配内存也是每个连接独享。<br>尽量在SQL与方面进行优化，效果较为明显。<br>优化的方法：在on条件列加索引，至少应当是有MUL索引</p>
                                    <h5 id="thread-cache-size"><a href="#thread-cache-size" class="headerlink" title="thread_cache_size"></a>thread_cache_size</h5>
                                    <blockquote>
                                        <p>服务器线程缓存，这个值表示可以重新利用保存在缓存中线程的数量,当断开连接时,那么客户端的线程将被放到缓存中以响应下一个客户而不是销毁(前提是缓存数未达上限),如果线程重新被请求，那么请求将从缓存中读取,如果缓存中是空的或者是新的请求，那么这个线程将被重新创建,如果有很多新的线程，增加这个值可以改善系统性能</p>
                                    </blockquote>
                                    <p>通过比较 Connections 和 Threads_created 状态的变量，可以看到这个变量的作用。<br>设置规则如下：1GB 内存配置为8，2GB配置为16，3GB配置为32，4GB或更高内存，可配置更大。<br>服务器处理此客户的线程将会缓存起来以响应下一个客户而不是销毁(前提是缓存数未达上限)</p>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th style="text-align:left">Variable_name</th>
                                                    <th style="text-align:left">Value</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="text-align:left">Threads_cached</td>
                                                    <td style="text-align:left">178</td>
                                                    <td>当前此时此刻线程缓存中有多少空闲线程</td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Threads_connected</td>
                                                    <td style="text-align:left">78</td>
                                                    <td>当前已建立连接的数量，因为一个连接就需要一个线程，所以也可以看成当前被使用的线程数</td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Threads_created</td>
                                                    <td style="text-align:left">479</td>
                                                    <td>从最近一次服务启动，已创建线程的数量，如果发现Threads_created值过大的话，表明MySQL服务器一直在创建线程，这也是比较耗cpu SYS资源，可以适当增加配置文件中thread_cache_size值</td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Threads_running</td>
                                                    <td style="text-align:left">2</td>
                                                    <td>当前激活的（非睡眠状态）线程数。并不是代表正在使用的线程数，有时候连接已建立，但是连接处于sleep状态</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <p>Threads_created ：一般在架构设计阶段，会设置一个测试值，做压力测试。<br>结合zabbix监控，看一段时间内此状态的变化。<br>如果在一段时间内，Threads_created趋于平稳，说明对应参数设定是OK。<br>如果一直陡峭的增长，或者出现大量峰值，那么继续增加此值的大小，在系统资源够用的情况下（内存）</p>
                                    <h5 id="innodb-buffer-pool-size"><a href="#innodb-buffer-pool-size" class="headerlink" title="innodb_buffer_pool_size"></a>innodb_buffer_pool_size</h5>
                                    <blockquote>
                                        <p>对于InnoDB表来说，innodb_buffer_pool_size的作用就相当于key_buffer_size对于MyISAM表的作用一样。</p>
                                    </blockquote>
                                    <p><em><u>配置依据</u></em></p>
                                    <p>InnoDB使用该参数指定大小的内存来缓冲数据和索引。</p>
                                    <p>对于单独的MySQL数据库服务器，最大可以把该值设置成物理内存的80%,一般我们建议不要超过物理内存的70%。</p>
                                    <p><u><em>配置方法</em></u></p>
                                    <p>innodb_buffer_pool_size=2048M</p>
                                    <h5 id="innodb-flush-log-at-trx-commit"><a href="#innodb-flush-log-at-trx-commit" class="headerlink" title="innodb_flush_log_at_trx_commit"></a><strong>innodb_flush_log_at_trx_commit</strong></h5>
                                    <p>主要控制了innodb将log buffer中的数据写入日志文件并flush磁盘的时间点，取值分别为0、1、2三个。<br>0，表示当事务提交时，不做日志写入操作，而是每秒钟将log buffer中的数据写入日志文件并flush磁盘一次；<br>1，每次事务的提交都会引起redo日志文件写入、flush磁盘的操作，确保了事务的ACID；<br>2，每次事务提交引起写入日志文件的动作,但每秒钟完成一次flush磁盘操作。</p>
                                    <p><strong><em>配置依据</em></strong><br>实际测试发现，该值对插入数据的速度影响非常大，设置为2时插入10000条记录只需要2秒，设置为0时只需要1秒，而设置为1时则需要229秒。因此，MySQL手册也建议尽量将插入操作合并成一个事务，这样可以大幅提高速度。<br>根据MySQL官方文档，在允许丢失最近部分事务的危险的前提下，可以把该值设为0或2。</p>
                                    <p><u><em>配置方法</em></u></p>
                                    <p>innodb_flush_log_at_trx_commit=1<br>双1标准中的一个1</p>
                                    <h5 id="innodb-thread-concurrency"><a href="#innodb-thread-concurrency" class="headerlink" title="innodb_thread_concurrency"></a><strong>innodb_thread_concurrency</strong></h5>
                                    <blockquote>
                                        <p>此参数用来设置innodb线程的并发数量，默认值为0表示不限制。</p>
                                    </blockquote>
                                    <p>在官方文档上，对于innodb_thread_concurrency的使用，也给出了一些建议，如下：</p>
                                    <ul>
                                        <li>如果一个工作负载中，并发用户线程的数量小于64，建议设置innodb_thread_concurrency=0；</li>
                                        <li>如果工作负载一直较为严重甚至偶尔达到顶峰，建议先设置innodb_thread_concurrency=128，<br>并通过不断的降低这个参数，96, 80, 64等等，直到发现能够提供最佳性能的线程数，</li>
                                    </ul>
                                    <p>假设系统通常有40到50个用户，但定期的数量增加至60，70，甚至200。你会发现，<br>性能在80个并发用户设置时表现稳定，如果高于这个数，性能反而下降。在这种情况下，<br>建议设置innodb_thread_concurrency参数为80，以避免影响性能。</p>
                                    <p>如果你不希望InnoDB使用的虚拟CPU数量比用户线程使用的虚拟CPU更多（比如20个虚拟CPU），<br>建议通过设置innodb_thread_concurrency 参数为这个值（也可能更低，这取决于性能体现），</p>
                                    <p>如果你的目标是将MySQL与其他应用隔离，你可以l考虑绑定mysqld进程到专有的虚拟CPU。<br>但是需 要注意的是，这种绑定，在myslqd进程一直不是很忙的情况下，可能会导致非最优的硬件使用率。在这种情况下，<br>你可能会设置mysqld进程绑定的虚拟 CPU，允许其他应用程序使用虚拟CPU的一部分或全部。<br>在某些情况下，最佳的innodb_thread_concurrency参数设置可以比虚拟CPU的数量小。<br>定期检测和分析系统，负载量、用户数或者工作环境的改变可能都需要对innodb_thread_concurrency参数的设置进行调整</p>
                                    <p>128 ——-&gt; top cpu<br><u><em>设置标准</em></u><br>1、当前系统cpu使用情况，均不均匀<br>top</p>
                                    <p>2、当前的连接数，有没有达到顶峰<br>show status like ‘threads_%’;<br>show processlist;<br>（3）配置方法：<br>innodb_thread_concurrency=8<br>方法:</p>
                                    <pre><code>   1. 看top ,观察每个cpu的各自的负载情况
2. 发现不平均,先设置参数为cpu个数,然后不断增加(一倍)这个数值
3. 一直观察top状态,直到达到比较均匀时,说明已经到位了.
</code></pre>
                                    <h5 id="innodb-log-buffer-size"><a href="#innodb-log-buffer-size" class="headerlink" title="innodb_log_buffer_size"></a><strong>innodb_log_buffer_size</strong></h5>
                                    <figure class="highlight objectivec">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">此参数确定些日志文件所用的内存大小，以M为单位。缓冲区更大能提高性能，对于较大的事务，可以增大缓存大小。</span><br><span class="line">innodb_log_buffer_size=<span class="number">128</span>M</span><br><span class="line">设定依据：</span><br><span class="line"><span class="number">1</span>、大事务： 存储过程调用 <span class="built_in">CALL</span></span><br><span class="line"><span class="number">2</span>、多事务</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="innodb-log-file-size-100M"><a href="#innodb-log-file-size-100M" class="headerlink" title="innodb_log_file_size = 100M"></a><strong><em>innodb_log_file_size = 100M</em></strong></h5>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">设置 ib_logfile0  ib_logfile1 </span><br><span class="line">此参数确定数据日志文件的大小，以M为单位，更大的设置可以提高性能.</span><br><span class="line">innodb_log_file_size &#x3D; 100M</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="innodb-log-files-in-group-3"><a href="#innodb-log-files-in-group-3" class="headerlink" title="innodb_log_files_in_group = 3"></a><strong>innodb_log_files_in_group = 3</strong></h5>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">为提高性能，MySQL可以以循环方式将日志文件写到多个文件。推荐设置为3</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="read-buffer-size-1M"><a href="#read-buffer-size-1M" class="headerlink" title="read_buffer_size = 1M"></a><strong>read_buffer_size = 1M</strong></h5>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">MySql读入缓冲区大小。对表进行顺序扫描的请求将分配一个读入缓冲区，MySql会为它分配一段内存缓冲区。如果对表的顺序扫描请求非常频繁，并且你认为频繁扫描进行得太慢，可以通过增加该变量值以及内存缓冲区大小提高其性能。和 sort_buffer_size一样，该参数对应的分配内存也是每个连接独享</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="read-rnd-buffer-size-1M"><a href="#read-rnd-buffer-size-1M" class="headerlink" title="read_rnd_buffer_size = 1M"></a><strong>read_rnd_buffer_size = 1M</strong></h5>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">MySql的随机读（查询操作）缓冲区大小。当按任意顺序读取行时(例如，按照排序顺序)，将分配一个随机读缓存区。进行排序查询时，MySql会首先扫描一遍该缓冲，以避免磁盘搜索，提高查询速度，如果需要排序大量数据，可适当调高该值。但MySql会为每个客户连接发放该缓冲空间，所以应尽量适当设置该值，以避免内存开销过大。</span><br><span class="line">注：顺序读是指根据索引的叶节点数据就能顺序地读取所需要的行数据。随机读是指一般需要根据辅助索引叶节点中的主键寻找实际行数据，而辅助索引和主键所在的数据段不同，因此访问方式是随机的。</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="bulk-insert-buffer-size-8M"><a href="#bulk-insert-buffer-size-8M" class="headerlink" title="bulk_insert_buffer_size = 8M"></a><strong>bulk_insert_buffer_size = 8M</strong></h5>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">批量插入数据缓存大小，可以有效提高插入效率，默认为8M</span><br><span class="line">tokuDB    percona</span><br><span class="line">myrocks   </span><br><span class="line">RocksDB</span><br><span class="line">TiDB</span><br><span class="line">MongoDB</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h5 id="binary-log"><a href="#binary-log" class="headerlink" title="binary log"></a><strong>binary log</strong></h5>
                                    <figure class="highlight kotlin">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">log-bin=/<span class="keyword">data</span>/mysql-bin</span><br><span class="line">binlog_cache_size = <span class="number">2</span>M <span class="comment">//为每个session 分配的内存，在事务过程中用来存储二进制日志的缓存, 提高记录bin-log的效率。没有什么大事务，dml也不是很频繁的情况下可以设置小一点，如果事务大而且多，dml操作也频繁，则可以适当的调大一点。前者建议是--1M，后者建议是：即 2--4M</span></span><br><span class="line">max_binlog_cache_size = <span class="number">8</span>M <span class="comment">//表示的是binlog 能够使用的最大cache 内存大小</span></span><br><span class="line">max_binlog_size= <span class="number">512</span>M <span class="comment">//指定binlog日志文件的大小，如果当前的日志大小达到max_binlog_size，还会自动创建新的二进制日志。你不能将该变量设置为大于1GB或小于4096字节。默认值是1GB。在导入大容量的sql文件时，建议关闭sql_log_bin，否则硬盘扛不住，而且建议定期做删除。</span></span><br><span class="line">expire_logs_days = <span class="number">7</span> <span class="comment">//定义了mysql清除过期日志的时间。</span></span><br><span class="line">二进制日志自动删除的天数。默认值为<span class="number">0</span>,表示“没有自动删除”。</span><br><span class="line">log-bin=/mysql-bin</span><br><span class="line">binlog_format=row </span><br><span class="line">sync_binlog=<span class="number">1</span></span><br><span class="line">双<span class="number">1</span>标准(基于安全的控制)：</span><br><span class="line">sync_binlog=<span class="number">1</span>   <span class="comment">// 什么时候刷新binlog到磁盘，每次事务commit</span></span><br><span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span><br><span class="line"><span class="keyword">set</span> sql_log_bin=<span class="number">0</span>;</span><br><span class="line">show status like <span class="string">'com_%'</span>;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight routeros">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">basedir</span>=/data/mysql</span><br><span class="line"><span class="attribute">datadir</span>=/data/mysql/data</span><br><span class="line"><span class="attribute">socket</span>=/tmp/mysql.sock</span><br><span class="line"><span class="attribute">log-error</span>=/var/log/mysql.log</span><br><span class="line"><span class="attribute">log_bin</span>=/data/binlog/mysql-bin</span><br><span class="line"><span class="attribute">binlog_format</span>=row</span><br><span class="line">skip-name-resolve</span><br><span class="line"><span class="attribute">server-id</span>=52</span><br><span class="line"><span class="attribute">gtid-mode</span>=on</span><br><span class="line"><span class="attribute">enforce-gtid-consistency</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">log-slave-updates</span>=1</span><br><span class="line"><span class="attribute">relay_log_purge</span>=0</span><br><span class="line"><span class="attribute">max_connections</span>=1024</span><br><span class="line"><span class="attribute">back_log</span>=128</span><br><span class="line"><span class="attribute">wait_timeout</span>=60</span><br><span class="line"><span class="attribute">interactive_timeout</span>=7200</span><br><span class="line"><span class="attribute">key_buffer_size</span>=16M</span><br><span class="line"><span class="attribute">query_cache_size</span>=64M</span><br><span class="line"><span class="attribute">query_cache_type</span>=1</span><br><span class="line"><span class="attribute">query_cache_limit</span>=50M</span><br><span class="line"><span class="attribute">max_connect_errors</span>=20</span><br><span class="line"><span class="attribute">sort_buffer_size</span>=2M</span><br><span class="line"><span class="attribute">max_allowed_packet</span>=32M</span><br><span class="line"><span class="attribute">join_buffer_size</span>=2M</span><br><span class="line"><span class="attribute">thread_cache_size</span>=200</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=1024M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=1</span><br><span class="line"><span class="attribute">innodb_log_buffer_size</span>=32M</span><br><span class="line"><span class="attribute">innodb_log_file_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_log_files_in_group</span>=3</span><br><span class="line"><span class="attribute">binlog_cache_size</span>=2M</span><br><span class="line"><span class="attribute">max_binlog_cache_size</span>=8M</span><br><span class="line"><span class="attribute">max_binlog_size</span>=512M</span><br><span class="line"><span class="attribute">expire_logs_days</span>=7</span><br><span class="line"><span class="attribute">read_buffer_size</span>=2M</span><br><span class="line"><span class="attribute">read_rnd_buffer_size</span>=2M</span><br><span class="line"><span class="attribute">bulk_insert_buffer_size</span>=8M</span><br><span class="line">[client]</span><br><span class="line"><span class="attribute">socket</span>=/tmp/mysql.sock</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h2 id="sql与索引优化"><a href="#sql与索引优化" class="headerlink" title="sql与索引优化"></a>sql与索引优化</h2>
                                    <h3 id="sql使用建议"><a href="#sql使用建议" class="headerlink" title="sql使用建议"></a>sql使用建议</h3>
                                    <p>1.对查询进行优化，应尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。</p>
                                    <p>2.应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span> <span class="keyword">is</span> <span class="literal">null</span> </span><br><span class="line">可以在<span class="keyword">num</span>上设置默认值<span class="number">0</span>，确保表中<span class="keyword">num</span>列没有<span class="literal">null</span>值，然后这样查询：</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">0</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>3.应尽量避免在 where 子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描。</p>
                                    <p>4.应尽量避免在 where 子句中使用 or 来连接条件，否则将导致引擎放弃使用索引而进行全表扫描，如： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">10</span> <span class="keyword">or</span> <span class="keyword">num</span>=<span class="number">20</span>   </span><br><span class="line">可以这样查询：   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">10</span>   </span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span>   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">20</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>5.in 和 not in 也要慎用，否则会导致全表扫描，如： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span> <span class="keyword">in</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)   </span><br><span class="line">对于连续的数值，能用 <span class="keyword">between</span> 就不要用 <span class="keyword">in</span> 了：   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">3</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>6.下面的查询也将导致全表扫描：</p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%abc%'</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>7.应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>/<span class="number">2</span>=<span class="number">100</span>   </span><br><span class="line">应改为:   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">num</span>=<span class="number">100</span>*<span class="number">2</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>8.应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">substring</span>(<span class="keyword">name</span>,<span class="number">1</span>,<span class="number">3</span>)=<span class="string">'abc'</span><span class="comment">--name以abc开头的id   </span></span><br><span class="line">应改为:   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> t <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'abc%'</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>9.不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。 </p>
                                    <p>10.在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使用，并且应尽可能的让字段顺序与索引顺序相一致。 </p>
                                    <p>11.不要写一些没有意义的查询，如需要生成一个空表结构</p>
                                    <p>12.很多时候用 exists 代替 in 是一个好的选择： </p>
                                    <figure class="highlight sql">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="keyword">select</span> <span class="keyword">num</span> <span class="keyword">from</span> a <span class="keyword">where</span> <span class="keyword">num</span> <span class="keyword">in</span>(<span class="keyword">select</span> <span class="keyword">num</span> <span class="keyword">from</span> b)   </span><br><span class="line">用下面的语句替换：   </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">num</span> <span class="keyword">from</span> a <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> b <span class="keyword">where</span> <span class="keyword">num</span>=a.num)</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>13.并不是所有索引对查询都有效，SQL是根据表中数据来进行查询优化的，当索引列有大量数据重复时，SQL查询可能不会去利用索引，如一表中有字段sex，male、female几乎各一半，那么即使在sex上建了索引也对查询效率起不了作用。 </p>
                                    <p>14.索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，<br>因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。<br>一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有必要。 </p>
                                    <p>15.尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。<br>这是因为引擎在处理查询和连接时会逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。 </p>
                                    <p>16.尽可能的使用 varchar 代替 char ，因为首先变长字段存储空间小，可以节省存储空间，<br>其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。 </p>
                                    <p>17.任何地方都不要使用 select <em> from t ，用具体的字段列表代替“</em>”，不要返回用不到的任何字段。 </p>
                                    <p>18.避免频繁创建和删除临时表，以减少系统表资源的消耗。</p>
                                    <p>19.临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件，最好使用导出表。</p>
                                    <p>20.在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，<br>以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</p>
                                    <p>21.如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。 </p>
                                    <p>22.尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。 </p>
                                    <p>23.使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。</p>
                                    <p>24.与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。</p>
                                    <p>在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。</p>
                                    <p>25.尽量避免大事务操作，提高系统并发能力。</p>
                                    <p>26.尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。</p>
                                    <h3 id="sql调优思路"><a href="#sql调优思路" class="headerlink" title="sql调优思路"></a>sql调优思路</h3>
                                    <ol>
                                        <li>slow_query_log 收集慢日志 结合explain分析索引命中与进行索引优化</li>
                                        <li>减少索引扫描行数，对于慢sql进行优化</li>
                                        <li>建立联合索引，由于联合索引的每个叶子节点都包含检索字段信息，按最左原则匹配，按照其他条件过滤，减少回表的数据量</li>
                                        <li>使用虚拟列和联合索引来提升复杂查询执行效率</li>
                                    </ol>
                                    <h3 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h3>
                                    <ol>
                                        <li>没有查询条件，或者查询条件没有建立索引</li>
                                        <li>查询结果集是原表中的大部分数据</li>
                                        <li>索引本身失效，统计数据不真实</li>
                                        <li>查询条件使用函数在索引列上，或者对索引列进行运算，运算包括(+，-，*，/，! 等)</li>
                                        <li>隐式转换导致索引失效</li>
                                        <li>&lt;&gt; ，not in 不走索引（辅助索引）</li>
                                        <li>ike “%_” 百分号在最前面不走</li>
                                    </ol>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-04 00:27:43" itemprop="dateCreated datePublished" datetime="2021-09-04T00:27:43+08:00">2021-09-04</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/507251385.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/507251385.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>8.5k</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>8 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/2760374101.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> Kubernetes <i class="label-arrow"></i>
                                    </a>
                                    <a href="/2760374101.html" class="post-title-link" itemprop="url">kubernetes NFS实践</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="NFS实践"><a href="#NFS实践" class="headerlink" title="NFS实践"></a>NFS实践</h2>
                                    <h3 id="安装NFS"><a href="#安装NFS" class="headerlink" title="安装NFS"></a>安装NFS</h3>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">yum install -y nfs-common nfs-utils rpcbind</span><br><span class="line">mkdir /nfs &amp;&amp; chmod 766 /nfs &amp;&amp; chown nfsnobody /nfs/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/nfs *(rw,no_root_squash,no_all_squash,sync)"</span> &gt;&gt; /etc/exports</span><br><span class="line">systemctl restart rpcbind &amp;&amp; systemctl restart nfs &amp;&amp; systemctl status rpcbind &amp;&amp; systemctl status nfs</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4>
                                    <figure class="highlight dart">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">showmount -e $IP</span><br><span class="line">mkdir /test &amp;&amp; cd $_ &amp;&amp; mount -t nfs $IP:/nfs /test</span><br><span class="line">echo <span class="string">"asdsadsa"</span> &gt;&gt; a.txt</span><br><span class="line">umount /test &amp;&amp; rm -rf /test</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="部署PV"><a href="#部署PV" class="headerlink" title="部署PV"></a>部署PV</h3>
                                    <figure class="highlight yaml">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv-master</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/nfs</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.27</span> <span class="comment"># 节点ip</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="PVC"><a href="#PVC" class="headerlink" title="PVC"></a>PVC</h3>
                                    <figure class="highlight yaml">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">wangyanglinux/myapp:v2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">"nfs"</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3>
                                    <figure class="highlight maxima">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">kubectl <span class="built_in">get</span> <span class="built_in">pv</span></span><br><span class="line">kubectl desc</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu3v3oji9fj62090u047b02.jpg" alt="image-20210903233505574"></p>
                                    <figure class="highlight lsl">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># <span class="number">192.168</span><span class="number">.0</span><span class="number">.27</span> /nfs</span><br><span class="line">echo <span class="string">"asds"</span>  &gt; index.html</span><br><span class="line">kubectl get pod -o wid</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu3vd2jo46j61vk04uace02.jpg" alt="image-20210903234426686"></p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">curl 10.244.1.53</span><br><span class="line"><span class="comment"># asds</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-03 23:46:49" itemprop="dateCreated datePublished" datetime="2021-09-03T23:46:49+08:00">2021-09-03</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/2760374101.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/2760374101.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>21</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>1 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/3191410054.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> 数据库 <i class="label-arrow"></i>
                                    </a>
                                    <a href="/3191410054.html" class="post-title-link" itemprop="url">MySQL的SQL使用之下</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="mysql用户管理"><a href="#mysql用户管理" class="headerlink" title="mysql用户管理"></a>mysql用户管理</h2>
                                    <blockquote>
                                        <p> DCL（Data Control Language，数据控制语言）：用于定义数据库的访问权限和安全级别，主要包含GRANT、REVOKE、COMMIT和ROLLBACK等语句。</p>
                                    </blockquote>
                                    <p><strong>mysql用户管理主要涉及到用户的增删改查与权限管理</strong></p>
                                    <p>mysql中存在4个控制权限的表，分别为user表，db表，tables_priv表，columns_priv表</p>
                                    <p><strong>权限表的验证过程</strong></p>
                                    <ol>
                                        <li>先从user表中的Host,User,Password这3个字段中判断连接的ip、用户名、密码是否存在，存在则通过验证。</li>
                                        <li>通过身份认证后，进行权限分配，按照user，db，tables_priv，columns_priv的顺序进行验证。即先检查全局权限表user，如果user中对应的权限为Y，则此用户对所有数据库的权限都为Y，将不再检查db, tables_priv,columns_priv；如果为N，则到db表中检查此用户对应的具体数据库，并得到db中为Y的权限；如果db中为N，则检查tables_priv中此数据库对应的具体表，取得表中的权限Y，以此类推。</li>
                                    </ol>
                                    <p><strong>MySQL 权限级别</strong><br>全局性的管理权限： 作用于整个MySQL实例级别<br>数据库级别的权限： 作用于某个指定的数据库上或者所有的数据库上<br>数据库对象级别的权限：作用于指定的数据库对象上（表、视图等）或者所有的数据库对象上</p>
                                    <h3 id="用户操作"><a href="#用户操作" class="headerlink" title="用户操作"></a>用户操作</h3>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 创建用户</span><br><span class="line">create user user_name@&#39;host&#39; identified by &#39;password&#39;;</span><br><span class="line"># example: </span><br><span class="line"># create user acs@&#39;10.0.0.%&#39; identified by &#39;123123&#39;;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 删除用户</span><br><span class="line">drop user user_name@&#39;host&#39;;</span><br><span class="line"># example:</span><br><span class="line"># drop user acs@&#39;10.0.0.%&#39;</span><br><span class="line"># DELETE FROM &#96;user&#96; WHERE &#96;user&#96;.&#96;Host&#96; &#x3D; &#39;10.0.0.%&#39; AND &#96;user&#96;.&#96;User&#96; &#x3D; &#39;acs&#39;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 修改用户</span><br><span class="line">alter user user_name@&#39;host&#39; identified by &#39;password&#39;;</span><br><span class="line"># example</span><br><span class="line">## 修改密码</span><br><span class="line">alter user acs@&#39;10.0.0.%&#39; identified by &#39;321312312123&#39;;</span><br><span class="line">## 修改 host</span><br><span class="line">UPDATE &#96;user&#96; SET &#96;Host&#96; &#x3D; &#39;%&#39; WHERE &#96;user&#96;.&#96;Host&#96; &#x3D; &#39;10.0.0.%&#39; AND &#96;user&#96;.&#96;User&#96; &#x3D; &#39;acs&#39;</span><br><span class="line">## 修改权限</span><br><span class="line">UPDATE &#96;user&#96; SET &#96;Select_priv&#96; &#x3D; &#39;Y&#39; WHERE &#96;user&#96;.&#96;Host&#96; &#x3D; &#39;%&#39; AND &#96;user&#96;.&#96;User&#96; &#x3D; &#39;acs&#39;</span><br><span class="line">UPDATE &#96;user&#96; SET &#96;Select_priv&#96; &#x3D; &#39;Y&#39;, &#96;Delete_priv&#96; &#x3D; &#39;Y&#39; WHERE &#96;user&#96;.&#96;Host&#96; &#x3D; &#39;%&#39; AND &#96;user&#96;.&#96;User&#96; &#x3D; &#39;acs&#39;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 删除用户</span><br><span class="line">drop user user_name@&#39;host&#39;;</span><br><span class="line"># example</span><br><span class="line">drop user acs@&#39;%&#39;</span><br><span class="line">DELETE FROM &#96;user&#96; WHERE &#96;user&#96;.&#96;Host&#96; &#x3D; &#39;10.0.0.%&#39; AND &#96;user&#96;.&#96;User&#96; &#x3D; &#39;acs&#39;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <blockquote>
                                        <p>user_name：用户名</p>
                                        <p>host ：可允许连接ip(Localhost代表本机， 127.0.0.1代表ipv4本机地址， ::1代表ipv6的本机地址,)</p>
                                        <p>password：用户密码</p>
                                    </blockquote>
                                    <h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2>
                                    <p>权限可细分为操作权限与操作范围</p>
                                    <p>常用权限介绍</p>
                                    <figure class="highlight dart">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">ALL:	SELECT,INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE</span><br><span class="line">ALL : 所有权限，一般是普通管理员拥有的</span><br><span class="line"><span class="keyword">with</span> grant option：给别的用户授权的功能</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>权限作用范围</p>
                                    <figure class="highlight dart">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">*.*               ----&gt;所有：管理员用户</span><br><span class="line">dbname.*          ----&gt;指定库下所有：开发和应用用户</span><br><span class="line">dbname.t1			----&gt;指定表</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p><strong>开发人员用户授权流程</strong></p>
                                    <ol>
                                        <li>你从哪来</li>
                                        <li>对谁操作</li>
                                        <li>权限</li>
                                        <li>密码要求</li>
                                    </ol>
                                    <h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3>
                                    <p>可以使用GRANT给用户添加权限，权限会自动叠加，不会覆盖之前授予的权限，比如你先给用户添加一个SELECT权限，后来又给用户添加了一个INSERT权限，那么该用户就同时拥有了SELECT和INSERT权限</p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 查看MYSQL有哪些用户</span><br><span class="line">select user,host from mysql.user;</span><br><span class="line"># 查看权限</span><br><span class="line">show grants for user_name@&#39;host&#39;;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 授权</span><br><span class="line">grant 权限 on 权限范围 to 用户 identified by 密码 with grant option;</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p> <strong>all privileges：</strong>表示将所有权限授予给用户。也可指定具体的权限，如：SELECT、CREATE、DROP等。<br> <strong>on：</strong>表示这些权限对哪些数据库和表生效，格式：数据库名.表名，这里写“<em>”表示所有数据库，所有表。如果我要指定将权限应用到test库的user表中，可以这么写：test.user<br> <strong>to：</strong>将权限授予哪个用户。格式：”用户名”@”登录IP或域名”。%表示没有限制，在任何主机都可以登录。比如：”payne”@”192.168.0%”，表示yangxin这个用户只能在192.168.0IP段登录<br> <strong>•identified by：</strong>指定用户的登录密码<br> <em>*•with grant option：</em></em>表示允许用户将自己的权限授权给其它用户 </p>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"># 收回权限</span><br><span class="line">revoke delete on 权限范围 from 用户@‘host’</span><br><span class="line">revoke delete on app.*  from app@&#39;10.0.0.%&#39;；</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h3 id="如何授权"><a href="#如何授权" class="headerlink" title="如何授权"></a>如何授权</h3>
                                    <p>用户的权限一定是与业务分离不开的，但通常普通用户会</p>
                                    <ul>
                                        <li>禁用删除权限</li>
                                        <li>规定范围</li>
                                    </ul>
                                    <h2 id="如何做好用户管理"><a href="#如何做好用户管理" class="headerlink" title="如何做好用户管理"></a>如何做好用户管理</h2>
                                    <ul>
                                        <li>密码系数足够高</li>
                                        <li>root禁用远程登录</li>
                                        <li>分级别，类似于公司管理。</li>
                                    </ul>
                                    <h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2>
                                    <figure class="highlight plain">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">8.0在grant命令添加新特性</span><br><span class="line">建用户和授权分开了</span><br><span class="line">grant 不再支持自动创建用户了，不支持改密码</span><br><span class="line">授权之前，必须要提前创建用户。</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <ul>
                                        <li>执行Grant,revoke,set password,rename user命令修改权限之后， MySQL会自动将修改后的权限信息同步加载到系统内存中</li>
                                        <li>如果执行insert/update/delete操作上述的系统权限表之后，则必须再执行刷新权限命令才能同步到系统内存中，刷新权限命令包括： <code>flush privileges</code>/mysqladmin flush-privileges / mysqladmin reload</li>
                                        <li>如果是修改tables和columns级别的权限，则客户端的下次操作新权限就会生效</li>
                                        <li>如果是修改database级别的权限，则新权限在客户端执行use database命令后生效</li>
                                        <li>如果是修改global级别的权限，则需要重新创建连接新权限才能生效</li>
                                        <li>如果是修改global级别的权限，则需要重新创建连接新权限才能生效 (例如修改密码)</li>
                                    </ul>
                                    <p>mysql user表</p>
                                    <div class="table-container">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th style="text-align:left"><strong>名字</strong></th>
                                                    <th style="text-align:left"><strong>类型</strong></th>
                                                    <th style="text-align:left">Null</th>
                                                    <th style="text-align:left">主键</th>
                                                    <th style="text-align:left">默认</th>
                                                    <th style="text-align:left"></th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td style="text-align:left">Host</td>
                                                    <td style="text-align:left">char(255)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left">PRI</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">User</td>
                                                    <td style="text-align:left">char(32)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left">PRI</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Select_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Insert_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Update_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Delete_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Drop_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Reload_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Shutdown_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Process_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">File_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Grant_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">References_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Index_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Alter_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Show_db_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Super_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_tmp_table_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Lock_tables_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Execute_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Repl_slave_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Repl_client_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_view_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Show_view_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_routine_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Alter_routine_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_user_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Event_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Trigger_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_tablespace_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">ssl_type</td>
                                                    <td style="text-align:left">enum(‘’,’ANY’,’X509’,’SPECIFIED’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">ssl_cipher</td>
                                                    <td style="text-align:left">blob</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">x509_issuer</td>
                                                    <td style="text-align:left">blob</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">x509_subject</td>
                                                    <td style="text-align:left">blob</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">max_questions</td>
                                                    <td style="text-align:left">int unsigned</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">0</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">max_updates</td>
                                                    <td style="text-align:left">int unsigned</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">0</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">max_connections</td>
                                                    <td style="text-align:left">int unsigned</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">0</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">max_user_connections</td>
                                                    <td style="text-align:left">int unsigned</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">0</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">plugin</td>
                                                    <td style="text-align:left">char(64)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">caching_sha2_password</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">authentication_string</td>
                                                    <td style="text-align:left">text</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">password_expired</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">password_last_changed</td>
                                                    <td style="text-align:left">timestamp</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">password_lifetime</td>
                                                    <td style="text-align:left">smallint unsigned</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">account_locked</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Create_role_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Drop_role_priv</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">NO</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left">N</td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Password_reuse_history</td>
                                                    <td style="text-align:left">smallint unsigned</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Password_reuse_time</td>
                                                    <td style="text-align:left">smallint unsigned</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">Password_require_current</td>
                                                    <td style="text-align:left">enum(‘N’,’Y’)</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td style="text-align:left">User_attributes</td>
                                                    <td style="text-align:left">json</td>
                                                    <td style="text-align:left">YES</td>
                                                    <td style="text-align:left"></td>
                                                    <td style="text-align:left"><em>NULL</em></td>
                                                    <td style="text-align:left"></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-02 21:46:39" itemprop="dateCreated datePublished" datetime="2021-09-02T21:46:39+08:00">2021-09-02</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/3191410054.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/3191410054.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>3.1k</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>3 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/2890729769.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> 容器编排 <i class="label-arrow"></i>
                                    </a>
                                    <a href="/2890729769.html" class="post-title-link" itemprop="url">docker分层构建</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="引子"><a href="#引子" class="headerlink" title="引子"></a>引子</h2>
                                    <p>​ 在构建、部署、测试等情景中下不知你也是否遇到过这么几个问题，构建慢、依赖安装慢、重复性构建。以至于每一次采用docker来构建时，都需要等上那么几分钟。有时候是非常的浪费时间，那么是否有方法进行一次分离构建呢。当然正如docker口号所说的那般”<strong>Build once，Run anywher</strong>“，</p>
                                    <p>那么该如何解决“<strong>构建慢、依赖安装慢、重复性构建</strong>”的问题呢，看似三个或者更多问题，其实归根结底是一个问题——分层构建</p>
                                    <h2 id="分层构建"><a href="#分层构建" class="headerlink" title="分层构建"></a>分层构建</h2>
                                    <p>想深层理解docker的分层构建，不得不从docker的设计特性出发。虚拟机与docker结构，如下图所示。</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gu2gf5gk5aj60kn0c40tr02.jpg" alt="image-20210902182150947"></p>
                                    <p><strong>一层一层的分层结构</strong>，那么所谓分层构建只需要将<strong>环境依赖</strong>与<strong>业务代码</strong>分开构建即可。实现如下</p>
                                    <ul>
                                        <li>
                                            <p>短时间内环境依赖构建一次且仅构建一次</p>
                                        </li>
                                        <li>
                                            <p>业务代码触发构建</p>
                                        </li>
                                    </ul>
                                    <h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2>
                                    <h3 id="python"><a href="#python" class="headerlink" title="python"></a>python</h3>
                                    <figure class="highlight dockerfile">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment">#构建环境依赖</span></span><br><span class="line"><span class="comment">## 拉取pythoo镜像</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span></span><br><span class="line"><span class="comment">## 设置环境变量，相当于linux的export</span></span><br><span class="line"><span class="keyword">ENV</span> PATH /usr/local/bin:$PATH</span><br><span class="line"><span class="comment">## 在容器中进入根目录code（如果没有code目录则创建）相当于cd</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /code</span></span><br><span class="line"><span class="comment">## 将执行docker build 路径下的所有文件copy到容器内所在的目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt .</span></span><br><span class="line"><span class="comment">## 执行shell命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install -U pip &amp;&amp; \</span></span><br><span class="line"><span class="bash">    python3 -m pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight sh">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># 构建</span></span><br><span class="line">docker build -t user/img_name:version .</span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">docker push user/img_name:version</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <figure class="highlight dockerfile">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment">#项目构建</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">user</span>/img_name:version</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"supervisord"</span>,<span class="string">"-c"</span>, <span class="string">"supervisord.conf"</span>]</span></span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <h4 id="golang"><a href="#golang" class="headerlink" title="golang"></a>golang</h4>
                                    <p>两层： 1.依赖构建 2.编译与项目构建</p>
                                    <p>三层： 1. 依赖构建 2.编译构建 3. 运行文件构建</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">FROM golang:1.16 as builder</span><br><span class="line"><span class="comment"># Setting environment variables</span></span><br><span class="line">ENV GOPROXY=<span class="string">"https://goproxy.cn,direct"</span> GO111MODULE=<span class="string">"on"</span> CGO_ENABLED=<span class="string">"0"</span> GOOS=<span class="string">"linux"</span> GOARCH=<span class="string">"amd64"</span></span><br><span class="line"><span class="comment">## add rely</span></span><br><span class="line">go mod tidy </span><br><span class="line"><span class="comment"># Switch to workspace</span></span><br><span class="line">WORKDIR /go/src/github.com/gowebspider/goproxies/</span><br><span class="line"><span class="comment"># Load file</span></span><br><span class="line">COPY . .</span><br><span class="line"><span class="comment"># Build and place the results in /tmp/goproxies</span></span><br><span class="line">RUN go build -o /tmp/goproxies .</span><br><span class="line"></span><br><span class="line">FROM alpine:latest</span><br><span class="line">WORKDIR /root/</span><br><span class="line">COPY --from=builder /tmp/goproxies .</span><br><span class="line">CMD [<span class="string">"./goproxies"</span>]</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-09-02 18:08:44" itemprop="dateCreated datePublished" datetime="2021-09-02T18:08:44+08:00">2021-09-02</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/2890729769.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/2890729769.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>386</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>1 分钟</span>
                                </span>
                            </div>
                        </article>
                        <article itemscope itemtype="http://schema.org/Article" class="post-block index" lang="zh-CN">
                            <link itemprop="mainEntityOfPage" href="https://paynewu.com/4032605777.html">
                            <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <meta itemprop="image" content="/images/favicon/android-chrome-512x512.png">
                                <meta itemprop="name" content="吴志鹏">
                                <meta itemprop="description" content="Talk is free，please state clearly">
                            </span>
                            <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
                                <meta itemprop="name" content="吴志鹏｜Payne-Wu">
                            </span>
                            <header class="post-header">
                                <h2 class="post-title" itemprop="name headline">
                                    <a class="label"> Error Set <i class="label-arrow"></i>
                                    </a>
                                    <a href="/4032605777.html" class="post-title-link" itemprop="url">cni already has an IP address different from ...</a>
                                </h2>
                            </header>
                            <div class="post-body" itemprop="articleBody">
                                <div class="thumb">
                                    <img itemprop="contentUrl" class="random">
                                </div>
                                <div class="excerpt">
                                    <p>
                                    <h2 id="错误如下"><a href="#错误如下" class="headerlink" title="错误如下"></a>错误如下</h2>
                                    <p>cni already has an IP address different from …</p>
                                    <p>如图所示</p>
                                    <p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1gtz8c50ce1j627w0mex5w02.jpg" alt="1421630332579_.pic_hd"></p>
                                    <h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2>
                                    <p>node之前反复添加</p>
                                    <h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># 找到对应的节点</span></span><br><span class="line">kubectl get pod --all-namespace -o wide</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>在对应node上执行如下命令</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line"><span class="comment"># 重置Kubernetes集群</span></span><br><span class="line">kubeadm reset &amp;&amp; systemctl stop kubelet &amp;&amp; systemctl stop docker</span><br><span class="line"><span class="comment"># 删除残留</span></span><br><span class="line">rm -rf /var/lib/cni/ &amp;&amp; rm -rf /var/lib/kubelet/* &amp;&amp; rm -rf /etc/cni/</span><br><span class="line"><span class="comment"># 删除旧网络</span></span><br><span class="line">ifconfig cni0 down &amp;&amp; ifconfig flannel.1 down &amp;&amp; ifconfig docker0 down </span><br><span class="line">ip link delete cni0 &amp;&amp; ip link delete flannel.1</span><br><span class="line"><span class="comment"># 重启服务</span></span><br><span class="line">systemctl restart docker &amp;&amp; systemctl start kubelet</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>在master上获取join token</p>
                                    <figure class="highlight bash">
                                        <table>
                                            <tr>
                                                <td class="gutter">
                                                    <pre><span class="line">1</span><br></pre>
                                                </td>
                                                <td class="code">
                                                    <pre><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br></pre>
                                                </td>
                                            </tr>
                                        </table>
                                    </figure>
                                    <p>重新加入节点</p>
                                    <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2>
                                    <p><a href="https://www.cnblogs.com/wangxu01/articles/11803547.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangxu01/articles/11803547.html</a></p>
                                    </p>
                                </div>
                            </div>
                            <div class="post-meta">
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-user"></i>
                                    </span>
                                    <span class="post-meta-item-text">作者</span>
                                    <span><a href="/authors/Payne" class="author" itemprop="url" rel="index">Payne</a></span>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-calendar"></i>
                                    </span>
                                    <span class="post-meta-item-text">发表于</span>
                                    <time title="创建时间：2021-08-30 23:20:51" itemprop="dateCreated datePublished" datetime="2021-08-30T23:20:51+08:00">2021-08-30</time>
                                </span>
                                <span class="post-meta-item">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-comment"></i>
                                    </span>
                                    <span class="post-meta-item-text">Valine：</span>
                                    <a title="valine" href="/4032605777.html#valine-comments" itemprop="discussionUrl">
                                        <span class="post-comments-count valine-comment-count" data-xid="/4032605777.html" itemprop="commentCount"></span>
                                    </a>
                                </span>
                                <br>
                                <span class="post-meta-item" title="本文字数">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-file-word"></i>
                                    </span>
                                    <span class="post-meta-item-text">本文字数：</span>
                                    <span>165</span>
                                </span>
                                <span class="post-meta-item" title="阅读时长">
                                    <span class="post-meta-item-icon">
                                        <i class="far fa-clock"></i>
                                    </span>
                                    <span class="post-meta-item-text">阅读时长 &asymp;</span>
                                    <span>1 分钟</span>
                                </span>
                            </div>
                        </article>
                        <script>
                            document.querySelectorAll('.random').forEach(item => item.src = "https://picsum.photos/id/" + Math.floor(Math.random() * 300) + "/200/125?blur=" + Math.floor(Math.random() * Math.floor(3)))

                        </script>
                        <nav class="pagination">
                            <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
                        </nav>
                    </div>
                    <script>
                        window.addEventListener('tabs:register', () =>
                        {
                            let
                            {
                                activeClass
                            } = CONFIG.comments;
                            if (CONFIG.comments.storage)
                            {
                                activeClass = localStorage.getItem('comments_active') || activeClass;
                            }
                            if (activeClass)
                            {
                                let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
                                if (activeTab)
                                {
                                    activeTab.click();
                                }
                            }
                        });
                        if (CONFIG.comments.storage)
                        {
                            window.addEventListener('tabs:click', event =>
                            {
                                if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
                                let commentClass = event.target.classList[1];
                                localStorage.setItem('comments_active', commentClass);
                            });
                        }

                    </script>
                </div>
                <div class="toggle sidebar-toggle">
                    <span class="toggle-line toggle-line-first"></span>
                    <span class="toggle-line toggle-line-middle"></span>
                    <span class="toggle-line toggle-line-last"></span>
                </div>
                <aside class="sidebar">
                    <div class="sidebar-inner">
                        <ul class="sidebar-nav motion-element">
                            <li class="sidebar-nav-toc"> 文章目录 </li>
                            <li class="sidebar-nav-overview"> 站点概览 </li>
                        </ul>
                        <!--noindex-->
                        <div class="post-toc-wrap sidebar-panel">
                        </div>
                        <!--/noindex-->
                        <div class="site-overview-wrap sidebar-panel">
                            <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                                <img class="site-author-image" itemprop="image" alt="吴志鹏" src="/images/favicon/android-chrome-512x512.png">
                                <p class="site-author-name" itemprop="name">吴志鹏</p>
                                <div class="site-description" itemprop="description">Talk is free，please state clearly</div>
                            </div>
                            <div class="site-state-wrap motion-element">
                                <nav class="site-state">
                                    <div class="site-state-item site-state-posts">
                                        <a href="/archives/">
                                            <span class="site-state-item-count">77</span>
                                            <span class="site-state-item-name">日志</span>
                                        </a>
                                    </div>
                                    <div class="site-state-item site-state-categories">
                                        <a href="/categories/">
                                            <span class="site-state-item-count">50</span>
                                            <span class="site-state-item-name">分类</span></a>
                                    </div>
                                    <div class="site-state-item site-state-tags">
                                        <a href="/tags/">
                                            <span class="site-state-item-count">51</span>
                                            <span class="site-state-item-name">标签</span></a>
                                    </div>
                                </nav>
                            </div>
                            <div class="links-of-author motion-element">
                                <span class="links-of-author-item">
                                    <a href="https://github.com/Payne-Wu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Payne-Wu" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
                                </span>
                                <span class="links-of-author-item">
                                    <a href="mailto:wuzhipeng1289690157@gmail.com" title="E-Mail → mailto:wuzhipeng1289690157@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
                                </span>
                                <span class="links-of-author-item">
                                    <a href="https://www.zhihu.com/people/wu-zhi-peng-72-78" title="ZhiHu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;wu-zhi-peng-72-78" rel="noopener" target="_blank"><i class="fa fa-magic fa-fw"></i>ZhiHu</a>
                                </span>
                                <span class="links-of-author-item">
                                    <a href="https://weibo.com/u/6987234483" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;6987234483" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
                                </span>
                            </div>
                        </div>
                    </div>
                </aside>
                <div id="sidebar-dimmer"></div>
            </div>
        </main>
        <footer class="footer">
            <div class="footer-inner">
                <div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span>
                    <span class="with-love">
                        <i class="fa fa-heart"></i>
                    </span>
                    <span class="author" itemprop="copyrightHolder">paynewu</span>
                    <span class="post-meta-divider">|</span>
                    <span class="post-meta-item-icon">
                        <i class="fa fa-chart-area"></i>
                    </span>
                    <span title="站点总字数">176k</span>
                    <span class="post-meta-divider">|</span>
                    <span class="post-meta-item-icon">
                        <i class="fa fa-coffee"></i>
                    </span>
                    <span title="站点阅读时长">2:40</span>
                </div>
            </div>
        </footer>
    </div>
    <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/.js"></script>
    <script src="/js/schemes/pisces.js"></script>
    <script src="/.js"></script>
    <script src="/js/next-boot.js"></script>
    <script src="/.js"></script>
    <script>
        (function ()
        {
            var canonicalURL, curProtocol;
            //Get the <link> tag
            var x = document.getElementsByTagName("link");
            //Find the last canonical URL
            if (x.length > 0)
            {
                for (i = 0; i < x.length; i++)
                {
                    if (x[i].rel.toLowerCase() == 'canonical' && x[i].href)
                    {
                        canonicalURL = x[i].href;
                    }
                }
            }
            //Get protocol
            if (!canonicalURL)
            {
                curProtocol = window.location.protocol.split(':')[0];
            }
            else
            {
                curProtocol = canonicalURL.split(':')[0];
            }
            //Get current URL if the canonical URL does not exist
            if (!canonicalURL) canonicalURL = window.location.href;
            //Assign script content. Replace current URL with the canonical URL
            ! function ()
            {
                var e = /([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,
                    r = canonicalURL,
                    t = document.referrer;
                if (!e.test(r))
                {
                    var n = (String(curProtocol).toLowerCase() === 'https') ? "https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif" : "//api.share.baidu.com/s.gif";
                    t ? (n += "?r=" + encodeURIComponent(document.referrer), r && (n += "&l=" + r)) : r && (n += "?l=" + r);
                    var i = new Image;
                    i.src = n
                }
            }(window);
        })();

    </script>
    <script src="/js/local-search.js"></script>
    <script src="/.js"></script>
    <script>
        NexT.utils.loadComments(document.querySelector('#valine-comments'), () =>
        {
            NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () =>
            {
                var GUEST = ['nick', 'mail', 'link'];
                var guest = 'nick,mail,link';
                guest = guest.split(',').filter(item =>
                {
                    return GUEST.includes(item);
                });
                new Valine(
                {
                    el: '#valine-comments',
                    verify: false,
                    notify: false,
                    appId: 'v5yI1sEaxpTl6gCkO0dApNOH-gzGzoHsz',
                    appKey: 'ugl27izkUCvh7RIyvo7kcFCv',
                    placeholder: "Just go go",
                    avatar: 'mm',
                    meta: guest,
                    pageSize: '10' || 10,
                    visitor: false,
                    lang: 'zh-cn' || 'zh-cn',
                    path: location.pathname,
                    recordIP: true,
                    serverURLs: ''
                });
            }, window.Valine);
        });

    </script>
</body>

</html>
