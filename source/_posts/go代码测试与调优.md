---
title: goä»£ç æµ‹è¯•ä¸è°ƒä¼˜
author: Payne
tags: ["Go"]
categories:
- ["Go"]
date: 2021-04-14 00:54:33
---
åœ¨äº†è§£golangçš„æµ‹è¯•ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹goè¯­è¨€è‡ªå¸¦çš„æµ‹è¯•å·¥å…·-go test

## go testå·¥å…·

Goè¯­è¨€ä¸­çš„æµ‹è¯•ä¾èµ–`go test`å‘½ä»¤ã€‚ç¼–å†™æµ‹è¯•ä»£ç å’Œç¼–å†™æ™®é€šçš„Goä»£ç è¿‡ç¨‹æ˜¯ç±»ä¼¼çš„ï¼Œå¹¶ä¸éœ€è¦å­¦ä¹ æ–°çš„è¯­æ³•ã€è§„åˆ™æˆ–å·¥å…·ã€‚
<!--more-->
go testå‘½ä»¤æ˜¯ä¸€ä¸ªæŒ‰ç…§ä¸€å®šçº¦å®šå’Œç»„ç»‡çš„æµ‹è¯•ä»£ç çš„é©±åŠ¨ç¨‹åºã€‚åœ¨åŒ…ç›®å½•å†…ï¼Œæ‰€æœ‰ä»¥`_test.go`ä¸ºåç¼€åçš„æºä»£ç æ–‡ä»¶éƒ½æ˜¯`go test`æµ‹è¯•çš„ä¸€éƒ¨åˆ†ï¼Œä¸ä¼šè¢«`go build`ç¼–è¯‘åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ã€‚

åœ¨`*_test.go`æ–‡ä»¶ä¸­æœ‰ä¸‰ç§ç±»å‹çš„å‡½æ•°ï¼Œå•å…ƒæµ‹è¯•å‡½æ•°ã€åŸºå‡†æµ‹è¯•å‡½æ•°å’Œç¤ºä¾‹å‡½æ•°ã€‚

|   ç±»å‹   |         æ ¼å¼          |              ä½œç”¨              |
| :------: | :-------------------: | :----------------------------: |
| æµ‹è¯•å‡½æ•° |   å‡½æ•°åå‰ç¼€ä¸ºTest    | æµ‹è¯•ç¨‹åºçš„ä¸€äº›é€»è¾‘è¡Œä¸ºæ˜¯å¦æ­£ç¡® |
| åŸºå‡†å‡½æ•° | å‡½æ•°åå‰ç¼€ä¸ºBenchmark |         æµ‹è¯•å‡½æ•°çš„æ€§èƒ½         |
| ç¤ºä¾‹å‡½æ•° |  å‡½æ•°åå‰ç¼€ä¸ºExample  |       ä¸ºæ–‡æ¡£æä¾›ç¤ºä¾‹æ–‡æ¡£       |

#### è¿è¡Œæµç¨‹

`go test`å‘½ä»¤ä¼šéå†æ‰€æœ‰çš„`*_test.go`æ–‡ä»¶ä¸­ç¬¦åˆä¸Šè¿°å‘½åè§„åˆ™çš„å‡½æ•°ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªä¸´æ—¶çš„mainåŒ…ç”¨äºè°ƒç”¨ç›¸åº”çš„æµ‹è¯•å‡½æ•°ï¼Œç„¶åæ„å»ºå¹¶è¿è¡Œã€æŠ¥å‘Šæµ‹è¯•ç»“æœï¼Œæœ€åæ¸…ç†æµ‹è¯•ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶ã€‚

### ä½¿ç”¨è¯¦è§£

ä¸Šæ¬¡å¯¹äº`go test` å¹¶æ²¡æœ‰è¯¦ç»†çš„é˜è¿°ï¼Œè¿™æ¬¡è¡¥ä¸Šã€‚

go test çš„ä½¿ç”¨è¯­æ³•å¦‚ä¸‹

```sh
go test [build/test flags] [packages] [build/test flags & test binary flags]
# å¯ä»¥ç›´æ¥ go test ç›´æ¥è¿è¡Œï¼Œé‚£ä¹ˆå®ƒå°†è¿è¡Œæœ¬ç›®å½•ä¸‹çš„æ‰€æœ‰*_test.goçš„åŸºå‡†æµ‹è¯•ã€‚
# è¿˜å¯ä»¥è¿›è¡Œç¼–è¯‘åæµ‹è¯•ä¾‹å¦‚ go test build 
```

> æ›´å¤šè¯·æŸ¥çœ‹ `go help testfunc`ã€‚
>
> `go test` å‘½ä»¤è¿˜ä¼šå¿½ç•¥ `testdata` ç›®å½•ï¼Œè¯¥ç›®å½•ç”¨æ¥ä¿å­˜æµ‹è¯•éœ€è¦ç”¨åˆ°çš„è¾…åŠ©æ•°æ®ã€‚
>
> go test æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š
>
> 1ã€æœ¬åœ°ç›®å½•æ¨¡å¼ï¼Œåœ¨æ²¡æœ‰åŒ…å‚æ•°ï¼ˆä¾‹å¦‚ `go test` æˆ– `go test -v`ï¼‰è°ƒç”¨æ—¶å‘ç”Ÿã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œ`go test` ç¼–è¯‘å½“å‰ç›®å½•ä¸­æ‰¾åˆ°çš„åŒ…å’Œæµ‹è¯•ï¼Œç„¶åè¿è¡Œæµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œcaching æ˜¯ç¦ç”¨çš„ã€‚åœ¨åŒ…æµ‹è¯•å®Œæˆåï¼Œ`go test` æ‰“å°ä¸€ä¸ªæ¦‚è¦è¡Œï¼Œæ˜¾ç¤ºæµ‹è¯•çŠ¶æ€ã€åŒ…åå’Œè¿è¡Œæ—¶é—´ã€‚
>
> 2ã€åŒ…åˆ—è¡¨æ¨¡å¼ï¼Œåœ¨ä½¿ç”¨æ˜¾ç¤ºåŒ…å‚æ•°è°ƒç”¨ `go test` æ—¶å‘ç”Ÿï¼ˆä¾‹å¦‚ `go test math`ï¼Œ`go test ./...` ç”šè‡³æ˜¯ `go test .`ï¼‰ã€‚åœ¨æ­¤æ¨¡å¼ä¸‹ï¼Œgo æµ‹è¯•ç¼–è¯‘å¹¶æµ‹è¯•åœ¨å‘½ä»¤ä¸Šåˆ—å‡ºçš„æ¯ä¸ªåŒ…ã€‚å¦‚æœä¸€ä¸ªåŒ…æµ‹è¯•é€šè¿‡ï¼Œ`go test` åªæ‰“å°æœ€ç»ˆçš„ `ok` æ€»ç»“è¡Œã€‚å¦‚æœä¸€ä¸ªåŒ…æµ‹è¯•å¤±è´¥ï¼Œ`go test` å°†è¾“å‡ºå®Œæ•´çš„æµ‹è¯•è¾“å‡ºã€‚å¦‚æœä½¿ç”¨ `-bench` æˆ– `-v` æ ‡å¿—ï¼Œåˆ™ `go test` ä¼šè¾“å‡ºå®Œæ•´çš„è¾“å‡ºï¼Œç”šè‡³æ˜¯é€šè¿‡åŒ…æµ‹è¯•ï¼Œä»¥æ˜¾ç¤ºæ‰€è¯·æ±‚çš„åŸºå‡†æµ‹è¯•ç»“æœæˆ–è¯¦ç»†æ—¥å¿—è®°å½•ã€‚
>
> ä¸‹é¢è¯¦ç»†è¯´æ˜ä¸‹ `go test` çš„å…·ä½“ç”¨æ³•ï¼Œflag çš„ä½œç”¨åŠä¸€äº›ç›¸å…³ä¾‹å­ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼šä¸€äº› flag æ”¯æŒ `go test` å‘½ä»¤å’Œç¼–è¯‘åçš„äºŒè¿›åˆ¶æµ‹è¯•æ–‡ä»¶ã€‚å®ƒä»¬éƒ½èƒ½è¯†åˆ«åŠ  `-test.` å‰ç¼€çš„ flagï¼Œå¦‚ `go test -test.v`ï¼Œä½†ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¿…é¡»åŠ å‰ç¼€ `./sum.test -test.bench=.`ã€‚

å‚æ•°è¯¦è§£

### test flag

ä»¥ä¸‹ flag å¯ä»¥è·Ÿè¢« `go test` å‘½ä»¤ä½¿ç”¨ï¼š

- `-args`ï¼šä¼ é€’å‘½ä»¤è¡Œå‚æ•°ï¼Œè¯¥æ ‡å¿—ä¼šå°† -args ä¹‹åçš„å‚æ•°ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ä¼ é€’ï¼Œæœ€å¥½ä½œä¸ºæœ€åä¸€ä¸ªæ ‡å¿—ã€‚

```
  $ go test -args -p=true
```

- `-c`ï¼šç¼–è¯‘æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ä¸º [pkg].testï¼Œä¸è¿è¡Œæµ‹è¯•ã€‚

```
  $ go test -c && ./sum.test -p=true
```

- `-exec xprog`ï¼šä½¿ç”¨ xprog è¿è¡Œæµ‹è¯•ï¼Œè¡Œä¸ºåŒ `go run` ä¸€æ ·ï¼ŒæŸ¥çœ‹ `go help run`ã€‚
- `-i`ï¼šå®‰è£…ä¸æµ‹è¯•ç›¸å…³çš„åŒ…ï¼Œä¸è¿è¡Œæµ‹è¯•ã€‚

```
  $ go test -i
```

- `-o file`ï¼šç¼–è¯‘æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶å¹¶æŒ‡å®šæ–‡ä»¶ï¼ŒåŒæ—¶è¿è¡Œæµ‹è¯•ã€‚

```
  go test -o filename
```

### test/binary flag

ä»¥ä¸‹æ ‡å¿—åŒæ—¶æ”¯æŒæµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶å’Œ `go test` å‘½ä»¤ã€‚

- `-bench regexp`ï¼šé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ‰§è¡ŒåŸºå‡†æµ‹è¯•ï¼Œé»˜è®¤ä¸æ‰§è¡ŒåŸºå‡†æµ‹è¯•ã€‚å¯ä»¥ä½¿ç”¨ `-bench .`æˆ–`-bench=.`æ‰§è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•ã€‚

```
  $ go test -bench=.
  $ go test -c
  $ ./sum.test -test.bench=.
```

- `-benchtime t`ï¼šæ¯ä¸ªåŸºå‡†æµ‹è¯•è¿è¡Œè¶³å¤Ÿè¿­ä»£æ¶ˆè€—çš„æ—¶é—´ï¼Œtime.Durationï¼ˆå¦‚ -benchtime 1h30sï¼‰ï¼Œé»˜è®¤ 1sã€‚

```
  $ go test -bench=. -benchtime 0.1s
  $ ./sum.test -test.bench=. -test.benchtime=1s
```

- `-count n`ï¼šè¿è¡Œæ¯ä¸ªæµ‹è¯•å’ŒåŸºå‡†æµ‹è¯•çš„æ¬¡æ•°ï¼ˆé»˜è®¤ 1ï¼‰ï¼Œå¦‚æœ -cpu æŒ‡å®šäº†ï¼Œåˆ™æ¯ä¸ª GOMAXPROCS å€¼æ‰§è¡Œ n æ¬¡ï¼ŒExamples æ€»æ˜¯è¿è¡Œä¸€æ¬¡ã€‚

```
  $ go test -bench=. -count=2
  $ ./sum.test -test.bench=. -test.count=2
```

- `-cover`ï¼šå¼€å¯è¦†ç›–åˆ†æï¼Œå¼€å¯è¦†ç›–åˆ†æå¯èƒ½ä¼šåœ¨ç¼–è¯‘æˆ–æµ‹è¯•å¤±è´¥æ—¶ï¼Œä»£ç è¡Œæ•°ä¸å¯¹ã€‚

```
  $ go test -bench=. -cover
```

- ```
  -covermode set,count,atomic
  ```

  ï¼šè¦†ç›–åˆ†æçš„æ¨¡å¼ï¼Œé»˜è®¤æ˜¯ setï¼Œå¦‚æœè®¾ç½® -raceï¼Œå°†ä¼šå˜ä¸º atomicã€‚

    - setï¼Œboolï¼Œè¿™ä¸ªè¯­å¥è¿è¡Œå—ï¼Ÿ
    - countï¼Œintï¼Œè¯¥è¯­å¥è¿è¡Œå¤šå°‘æ¬¡ï¼Ÿ
    - atomicï¼Œintï¼Œæ•°é‡ï¼Œåœ¨å¤šçº¿ç¨‹æ­£ç¡®ä½¿ç”¨ï¼Œä½†æ˜¯è€—èµ„æºçš„ã€‚

- `-coverpkg pkg1,pkg2,pkg3`ï¼šæŒ‡å®šåˆ†æå“ªä¸ªåŒ…ï¼Œé»˜è®¤å€¼åªåˆ†æè¢«æµ‹è¯•çš„åŒ…ï¼ŒåŒ…ä¸ºå¯¼å…¥çš„è·¯å¾„ã€‚

```
  # sum -> $GOPATH/src/test/sum
  $ go test -coverpkg test/sum
```

- `-cpu 1,2,4`ï¼šæŒ‡å®šæµ‹è¯•æˆ–åŸºå‡†æµ‹è¯•çš„ GOMAXPROCS å€¼ã€‚é»˜è®¤ä¸º GOMAXPROCS çš„å½“å‰å€¼ã€‚
- `-list regexp`ï¼šåˆ—å‡ºä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æµ‹è¯•ã€åŸºå‡†æµ‹è¯•æˆ– Examplesã€‚åªåˆ—å‡ºé¡¶çº§æµ‹è¯•ï¼ˆä¸åˆ—å‡ºå­æµ‹è¯•ï¼‰ï¼Œä¸è¿è¡Œæµ‹è¯•ã€‚

```
  $ go test -list Sum
```

- `-parallel n`ï¼šå…è®¸å¹¶è¡Œæ‰§è¡Œé€šè¿‡è°ƒç”¨ t.Parallel çš„æµ‹è¯•å‡½æ•°çš„æœ€å¤§æ¬¡æ•°ã€‚é»˜è®¤å€¼ä¸º GOMAXPROCS çš„å€¼ã€‚-parallel ä»…é€‚ç”¨äºå•ä¸ªäºŒè¿›åˆ¶æµ‹è¯•æ–‡ä»¶ï¼Œä½†`go test`å‘½ä»¤å¯ä»¥é€šè¿‡æŒ‡å®š -p å¹¶è¡Œæµ‹è¯•ä¸åŒçš„åŒ…ã€‚æŸ¥çœ‹ `go help build`ã€‚

```
  $ go test -run=TestSumParallel -parallel=2
```

- `-run regexp`ï¼šåªè¿è¡Œä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æµ‹è¯•å’ŒExamplesã€‚å¯ä»¥é€šè¿‡ / æ¥æŒ‡å®šæµ‹è¯•å­å‡½æ•°ã€‚`go test Foo/A=`ï¼Œä¼šå…ˆå»åŒ¹é…å¹¶æ‰§è¡Œ Foo å‡½æ•°ï¼Œå†æŸ¥æ‰¾å­å‡½æ•°ã€‚

```
  $ go test -v -run TestSumSubTest/1+
```

- `-short`ï¼šç¼©çŸ­é•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•çš„æµ‹è¯•æ—¶é—´ã€‚é»˜è®¤å…³é—­ã€‚

```
  $ go test -short
```

- `-timeout d`ï¼šå¦‚æœäºŒè¿›åˆ¶æµ‹è¯•æ–‡ä»¶æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œpanicã€‚é»˜è®¤10åˆ†é’Ÿï¼ˆ10mï¼‰ã€‚

```
  $ go test -run TestSumLongTime -timeout 1s
```

- `-v`ï¼šè¯¦ç»†è¾“å‡ºï¼Œè¿è¡ŒæœŸé—´æ‰€æœ‰æµ‹è¯•çš„æ—¥å¿—ã€‚

```
  $ go test -v
```

### analyze flag

ä»¥ä¸‹æµ‹è¯•é€‚ç”¨äº `go test` å’Œæµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

- `-benchmem`ï¼šæ‰“å°ç”¨äºåŸºå‡†çš„å†…å­˜åˆ†é…ç»Ÿè®¡æ•°æ®ã€‚

```
  $ go test -bench=. -benchmem
  $ ./sum.test -test.bench -test.benchmem
```

- `-blockprofile block.out`ï¼šå½“æ‰€æœ‰çš„æµ‹è¯•éƒ½å®Œæˆæ—¶ï¼Œåœ¨æŒ‡å®šçš„æ–‡ä»¶ä¸­å†™å…¥ä¸€ä¸ª goroutine é˜»å¡æ¦‚è¦æ–‡ä»¶ã€‚æŒ‡å®š -cï¼Œå°†å†™å…¥æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

```
  $ go test -v -cpuprofile=prof.out
  $ go tool pprof prof.out
```

- `-blockprofilerate n`ï¼šgoroutine é˜»å¡æ—¶å€™æ‰“ç‚¹çš„çº³ç§’æ•°ã€‚é»˜è®¤ä¸è®¾ç½®å°±ç›¸å½“äº -test.blockprofilerate=1ï¼Œæ¯ä¸€çº³ç§’éƒ½æ‰“ç‚¹è®°å½•ä¸€ä¸‹ã€‚
- `-coverprofile cover.out`ï¼šåœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œå°†è¦†ç›–æ¦‚è¦æ–‡ä»¶å†™åˆ°æ–‡ä»¶ä¸­ã€‚è®¾ç½®è¿‡ -coverã€‚
- `-cpuprofile cpu.out`ï¼šåœ¨é€€å‡ºä¹‹å‰ï¼Œå°†ä¸€ä¸ª CPU æ¦‚è¦æ–‡ä»¶å†™å…¥æŒ‡å®šçš„æ–‡ä»¶ã€‚
- `-memprofile mem.out`ï¼šåœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œå°†å†…å­˜æ¦‚è¦æ–‡ä»¶å†™åˆ°æ–‡ä»¶ä¸­ã€‚
- `-memprofilerate n`ï¼šå¼€å¯æ›´ç²¾ç¡®çš„å†…å­˜é…ç½®ã€‚å¦‚æœä¸º 1ï¼Œå°†ä¼šè®°å½•æ‰€æœ‰å†…å­˜åˆ†é…åˆ° profileã€‚

```
  $ go test -memprofile mem.out -memprofilerate 1
  $ go tool pprof mem.out
```

- `-mutexprofile mutex.out`ï¼šå½“æ‰€æœ‰çš„æµ‹è¯•éƒ½å®Œæˆæ—¶ï¼Œåœ¨æŒ‡å®šçš„æ–‡ä»¶ä¸­å†™å…¥ä¸€ä¸ªäº’æ–¥é”äº‰ç”¨æ¦‚è¦æ–‡ä»¶ã€‚æŒ‡å®š -cï¼Œå°†å†™å…¥æµ‹è¯•äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
- `-mutexprofilefraction n`ï¼šæ ·æœ¬ 1 åœ¨ n ä¸ªå †æ ˆä¸­ï¼Œgoroutines æŒæœ‰ aï¼Œäº‰ç”¨äº’æ–¥é”ã€‚
- `-outputdir directory`ï¼šåœ¨æŒ‡å®šçš„ç›®å½•ä¸­æ”¾ç½®è¾“å‡ºæ–‡ä»¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œ`go test` æ­£åœ¨è¿è¡Œçš„ç›®å½•ã€‚
- `-trace trace.out`ï¼šåœ¨é€€å‡ºä¹‹å‰ï¼Œå°†æ‰§è¡Œè·Ÿè¸ªå†™å…¥æŒ‡å®šæ–‡ä»¶ã€‚



## å•å…ƒæµ‹è¯•

> ä»¥ä¸‹æ˜¯æ¥è‡ªwikiå¯¹äºå•å…ƒæµ‹è¯•çš„å®šä¹‰

åœ¨[è®¡ç®—æœºç¼–ç¨‹](https://zh.wikipedia.org/wiki/è®¡ç®—æœºç¼–ç¨‹)ä¸­ï¼Œ**å•å…ƒæµ‹è¯•**ï¼ˆè‹±è¯­ï¼šUnit Testingï¼‰åˆç§°ä¸º**æ¨¡å—æµ‹è¯•**ï¼Œæ˜¯é’ˆå¯¹[ç¨‹åºæ¨¡å—](https://zh.wikipedia.org/wiki/æ¨¡çµ„_(ç¨‹å¼è¨­è¨ˆ))ï¼ˆ[è½¯ä»¶è®¾è®¡](https://zh.wikipedia.org/wiki/è½¯ä»¶è®¾è®¡)çš„æœ€å°å•ä½ï¼‰æ¥è¿›è¡Œæ­£ç¡®æ€§æ£€éªŒçš„æµ‹è¯•å·¥ä½œã€‚ç¨‹åºå•å…ƒæ˜¯åº”ç”¨çš„æœ€å°å¯æµ‹è¯•éƒ¨ä»¶ã€‚åœ¨[è¿‡ç¨‹åŒ–ç¼–ç¨‹](https://zh.wikipedia.org/wiki/éç¨‹åŒ–ç·¨ç¨‹)ä¸­ï¼Œä¸€ä¸ªå•å…ƒå°±æ˜¯å•ä¸ªç¨‹åºã€å‡½æ•°ã€è¿‡ç¨‹ç­‰ï¼›å¯¹äºé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæœ€å°å•å…ƒå°±æ˜¯æ–¹æ³•ï¼ŒåŒ…æ‹¬åŸºç±»ï¼ˆè¶…ç±»ï¼‰ã€æŠ½è±¡ç±»ã€æˆ–è€…æ´¾ç”Ÿç±»ï¼ˆå­ç±»ï¼‰ä¸­çš„æ–¹æ³•ã€‚

é€šå¸¸æ¥è¯´ï¼Œç¨‹åºå‘˜æ¯ä¿®æ”¹ä¸€æ¬¡ç¨‹åºå°±ä¼šè¿›è¡Œæœ€å°‘ä¸€æ¬¡å•å…ƒæµ‹è¯•ï¼Œåœ¨ç¼–å†™ç¨‹åºçš„è¿‡ç¨‹ä¸­å‰åå¾ˆå¯èƒ½è¦è¿›è¡Œå¤šæ¬¡å•å…ƒæµ‹è¯•ï¼Œä»¥è¯å®ç¨‹åºè¾¾åˆ°[è½¯ä»¶è§„æ ¼ä¹¦](https://zh.wikipedia.org/wiki/è¦æ ¼_(æŠ€è¡“æ¨™æº–))è¦æ±‚çš„å·¥ä½œç›®æ ‡ï¼Œæ²¡æœ‰[ç¨‹åºé”™è¯¯](https://zh.wikipedia.org/wiki/Bug)ï¼›è™½ç„¶å•å…ƒæµ‹è¯•ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†ä¹Ÿä¸åï¼Œè¿™ç‰µæ¶‰åˆ°[é¡¹ç›®ç®¡ç†](https://zh.wikipedia.org/wiki/å°ˆæ¡ˆç®¡ç†)çš„æ”¿ç­–å†³å®šã€‚

æ¯ä¸ªç†æƒ³çš„[æµ‹è¯•æ¡ˆä¾‹](https://zh.wikipedia.org/wiki/æµ‹è¯•æ¡ˆä¾‹)ç‹¬ç«‹äºå…¶å®ƒæ¡ˆä¾‹ï¼›ä¸ºæµ‹è¯•æ—¶éš”ç¦»æ¨¡å—ï¼Œç»å¸¸ä½¿ç”¨stubsã€mock[[1\]](https://zh.wikipedia.org/wiki/å•å…ƒæµ‹è¯•#cite_note-mocksarentstubs-1)æˆ–fakeç­‰æµ‹è¯•[é©¬ç”²ç¨‹åº](https://zh.wikipedia.org/w/index.php?title=é©¬ç”²ç¨‹åº&action=edit&redlink=1)ã€‚å•å…ƒæµ‹è¯•é€šå¸¸ç”±[è½¯ä»¶å¼€å‘äººå‘˜](https://zh.wikipedia.org/w/index.php?title=è½¯ä»¶å¼€å‘äººå‘˜&action=edit&redlink=1)ç¼–å†™ï¼Œç”¨äºç¡®ä¿ä»–ä»¬æ‰€å†™çš„ä»£ç ç¬¦åˆè½¯ä»¶éœ€æ±‚å’Œéµå¾ª[å¼€å‘ç›®æ ‡](https://zh.wikipedia.org/w/index.php?title=å¼€å‘ç›®æ ‡&action=edit&redlink=1)ã€‚å®ƒçš„å®æ–½æ–¹å¼å¯ä»¥æ˜¯éå¸¸æ‰‹åŠ¨çš„ï¼ˆé€è¿‡çº¸ç¬”ï¼‰ï¼Œæˆ–è€…æ˜¯åšæˆ[æ„å»ºè‡ªåŠ¨åŒ–](https://zh.wikipedia.org/wiki/æ§‹å»ºè‡ªå‹•åŒ–)çš„ä¸€éƒ¨åˆ†ã€‚

ç®€å•æ¥è¯´ï¼Œå•å…ƒæµ‹è¯•å°±æ˜¯ç¨‹åºå‘˜è‡ªå·±å¯¹äºè‡ªå·±çš„ä»£ç è¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸€ä¸ªå•å…ƒå°±æ˜¯å•ä¸ªç¨‹åºã€å‡½æ•°ã€è¿‡ç¨‹ç­‰ï¼›å¯¹äºé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæœ€å°å•å…ƒå°±æ˜¯æ–¹æ³•ï¼ŒåŒ…æ‹¬åŸºç±»ï¼ˆè¶…ç±»ï¼‰ã€æŠ½è±¡ç±»ã€æˆ–è€…æ´¾ç”Ÿç±»ï¼ˆå­ç±»ï¼‰ä¸­çš„æ–¹æ³•ã€‚

æ›´æœ‰ä¸€ç§å¼€å‘æ‰‹æ³•ï¼Œé‚£å°±æ˜¯TDDï¼ˆTest Driven Developmentï¼‰,æµ‹è¯•é©±åŠ¨å¼€å‘ã€‚æœŸæœ›å±€éƒ¨æœ€ä¼˜åˆ°å…¨å±€æœ€ä¼˜ï¼Œè¿™ä¸ªæ˜¯ä¸€ç§éå¸¸ä¸é”™çš„å¥½ä¹ æƒ¯

> è¯·æ³¨æ„è¿™é‡Œçš„å±€éƒ¨æœ€ä¼˜çš„ï¼Œå±€éƒ¨ï¼Œå¹¶ä¸æ˜¯å‡½æ•°å†…çš„è¯¦ç»†ã€‚è€Œæ˜¯æ•´ä¸ªå‡½æ•°ã€‚ç”šè‡³æ˜¯ä¸€ä¸ªç±»ï¼Œç­‰ç­‰ã€‚
>
> å› ä¸ºæœ‰äº›å‡½æ•°å†…éƒ¨çš„æœ€ä¼˜ï¼Œå¹¶éè¿™ä¸ªå‡½æ•°çš„æœ€ä¼˜ã€‚è¿™ç‚¹éœ€è¦æ ¼å¤–çš„æ³¨æ„ã€‚è‹¥æœ‰å…´è¶£ï¼Œå¯äº†è§£ä¸€ä¸‹æœ‰ç‚¹å…³ç³»çš„è´ªå¿ƒç®—æ³•

### æµ‹è¯•å‡½æ•°æ ¼å¼

å…¶ä¸­å‚æ•°`t`ç”¨äºæŠ¥å‘Šæµ‹è¯•å¤±è´¥å’Œé™„åŠ çš„æ—¥å¿—ä¿¡æ¯ã€‚ `testing.T`çš„æ‹¥æœ‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```go
func (c *T) Error(args ...interface{})
func (c *T) Errorf(format string, args ...interface{})
func (c *T) Fail()
func (c *T) FailNow()
func (c *T) Failed() bool
func (c *T) Fatal(args ...interface{})
func (c *T) Fatalf(format string, args ...interface{})
func (c *T) Log(args ...interface{})
func (c *T) Logf(format string, args ...interface{})
func (c *T) Name() string
func (t *T) Parallel()
func (t *T) Run(name string, f func(t *T)) bool
func (c *T) Skip(args ...interface{})
func (c *T) SkipNow()
func (c *T) Skipf(format string, args ...interface{})
func (c *T) Skipped() bool
```

è¯´äº†è¿™ä¹ˆå¤šï¼Œæ¥å®ç°ä¸€ä¸ª`ç®€å•çš„`stringä¸­çš„Splitå‡½æ•°ï¼Œå¹¶å¯¹ä»–è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œç„¶ååœ¨å‰–æä»£ç ã€‚äº†è§£å•å…ƒæµ‹è¯•çš„ç›¸å…³è§„èŒƒ

```go
// splits.go
package splitStr

import (
	"strings"
)

// split package with a single split function.

// Split slices s into all substrings separated by sep and
// returns a slice of the substrings between those separators.
func Split(s, sep string) (result []string) {
	i := strings.Index(s, sep)
	for i > -1 {
		result = append(result, s[:i])
		s = s[i+1:]
		i = strings.Index(s, sep)
	}
	result = append(result, s)
	return
}

// split_test.go
package splitStr

import (
	"reflect"
	"testing"
)

// TestSplit å•å…ƒæµ‹è¯•
func TestSplit(t *testing.T) { // æµ‹è¯•å‡½æ•°åå¿…é¡»ä»¥Testå¼€å¤´ï¼Œå¿…é¡»æ¥æ”¶ä¸€ä¸ª*testing.Tç±»å‹å‚æ•°
	got := Split("a:b:c", ":")         // ç¨‹åºè¾“å‡ºçš„ç»“æœ
	want := []string{"a", "b", "c"}    // æœŸæœ›çš„ç»“æœ
	if !reflect.DeepEqual(want, got) { // å› ä¸ºsliceä¸èƒ½ç›´æ¥æ¯”è¾ƒï¼Œå€ŸåŠ©åå°„åŒ…ä¸­çš„æ–¹æ³•æ¯”è¾ƒ
		t.Errorf("excepted:%v, got:%#v", want, got) // æµ‹è¯•å¤±è´¥è¾“å‡ºé”™è¯¯æç¤º
	}
}

// TestSplit2 å•å…ƒæµ‹è¯•ç»„
func TestSplit2(t *testing.T) {
	// å®šä¹‰ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ç±»å‹
	type test struct {
		input string
		sep   string
		want  []string
	}
	// å®šä¹‰ä¸€ä¸ªå­˜å‚¨æµ‹è¯•ç”¨ä¾‹çš„åˆ‡ç‰‡
	tests := []test{
		{input: "a:b:c", sep: ":", want: []string{"a", "b", "c"}},
		{input: "a:b:c", sep: ",", want: []string{"a:b:c"}},
		{input: "abcd", sep: "bc", want: []string{"a", "d"}},
	}
	// éå†åˆ‡ç‰‡ï¼Œé€ä¸€æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
	for _, tc := range tests {
		got := Split(tc.input, tc.sep)
		if !reflect.DeepEqual(got, tc.want) {
			t.Errorf("excepted:%v, got:%#v", tc.want, got)
		}
	}
}
```

è¿è¡Œç»“æœå¦‚ä¸‹

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gnrolzdwnuj318y0dq3z2.jpg)

è¯´æ˜æµ‹è¯•æˆåŠŸï¼Œæœ¬æ¬¡é€šè¿‡ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨`Terminal`é‡Œé¢ç›´æ¥è¿è¡Œ`go test`ï¼Œå‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤º

<img src="https://tva1.sinaimg.cn/large/008eGmZEgy1gnropdatxhj30oa0bg0t4.jpg" style="zoom:70%;" />



> æ¸©é¦¨æç¤ºï¼šå…³äºå¯èƒ½é€ æˆè¿è¡Œtestä¸æˆåŠŸåŸå› 
>
> ç›´æ¥åœ¨`split_test.go`,è¿è¡Œã€‚
>
> - æˆ–è®¸çŸ¥é“ï¼Œgoæ˜¯ä»¥æ–‡ä»¶å¤¹çš„æ–¹æ³•æ¥åŒºåˆ†é¡¹ç›®ã€‚æ‰€ä»¥å½“å‰æ–‡ä»¶ï¼Œå¹¶ä¸èƒ½è·‘åˆ°æ—è¾¹æ–‡ä»¶ä¸­å»æ‰¾åˆ°`Split`,ä»¥è‡³äºæµ‹è¯•å¤±è´¥ã€‚æˆ–æœªè¾¾åˆ°é¢„æœŸæ•ˆæœ
>
> é‚£ä¹ˆæ­£ç¡®çš„æ‰“å¼€æ–¹å¼åº”è¯¥æ˜¯ï¼Ÿ
>
> åœ¨golandä¸­ï¼Œé¼ æ ‡å³é”®ç‚¹å‡»runæµ‹è¯•æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ï¼Œé€‰æ‹©åé¢ç¬¬äºŒä¸ª `go test projectFileName`
>
> åœ¨`Terminal`ä¸­ï¼Œåº”åœ¨`æµ‹è¯•æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹`çš„è·¯å¾„ä¸­ï¼Œè¿›è¡Œ`go test [arge...]`

ç¤ºä¾‹çœ‹å®Œäº†ï¼Œé‚£ä¹ˆè¿›è¡Œç®€å•çš„å‰–æã€‚å…ˆä»å‡½æ•°æ–‡ä»¶è¯´èµ·ï¼Œ(ä¹Ÿå°±æ˜¯è¿™é‡Œçš„`splits.go`)

1. ä¸åœ¨æ˜¯`package main`,è€Œæ˜¯`packge projectFileName`
2. å‡½æ•°åå¤§å†™ï¼Œå¤§å†™æ„å‘³ç€å…¬æœ‰å‡½æ•°ï¼Œå¯æ”¯æŒå¤–éƒ¨è°ƒç”¨

æµ‹è¯•æ–‡ä»¶

1. æ–‡ä»¶åä¸º'*_test.go'
2. ä¸åœ¨æ˜¯`package main`,è€Œæ˜¯`packge projectFileName`
3. å‡½æ•°åä¸ºTestFuncName



## åŸºå‡†æµ‹è¯•

### åŸºå‡†æµ‹è¯•å‡½æ•°æ ¼å¼

åŸºå‡†æµ‹è¯•å°±æ˜¯åœ¨ä¸€å®šçš„å·¥ä½œè´Ÿè½½ä¹‹ä¸‹æ£€æµ‹ç¨‹åºæ€§èƒ½çš„ä¸€ç§æ–¹æ³•ã€‚åŸºå‡†æµ‹è¯•çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š

```go
func BenchmarkName(b *testing.B){
    // ...
}
```

åŸºå‡†æµ‹è¯•ä»¥`Benchmark`ä¸ºå‰ç¼€ï¼Œéœ€è¦ä¸€ä¸ª`*testing.B`ç±»å‹çš„å‚æ•°bï¼ŒåŸºå‡†æµ‹è¯•å¿…é¡»è¦æ‰§è¡Œ`b.N`æ¬¡ï¼Œè¿™æ ·çš„æµ‹è¯•æ‰æœ‰å¯¹ç…§æ€§ï¼Œ`b.N`çš„å€¼æ˜¯ç³»ç»Ÿæ ¹æ®å®é™…æƒ…å†µå»è°ƒæ•´çš„ï¼Œä»è€Œä¿è¯æµ‹è¯•çš„ç¨³å®šæ€§ã€‚ `testing.B`æ‹¥æœ‰çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```go
func (c *B) Error(args ...interface{})
func (c *B) Errorf(format string, args ...interface{})
func (c *B) Fail()
func (c *B) FailNow()
func (c *B) Failed() bool
func (c *B) Fatal(args ...interface{})
func (c *B) Fatalf(format string, args ...interface{})
func (c *B) Log(args ...interface{})
func (c *B) Logf(format string, args ...interface{})
func (c *B) Name() string
func (b *B) ReportAllocs()
func (b *B) ResetTimer()
func (b *B) Run(name string, f func(b *B)) bool
func (b *B) RunParallel(body func(*PB))
func (b *B) SetBytes(n int64)
func (b *B) SetParallelism(p int)
func (c *B) Skip(args ...interface{})
func (c *B) SkipNow()
func (c *B) Skipf(format string, args ...interface{})
func (c *B) Skipped() bool
func (b *B) StartTimer()
func (b *B) StopTimer()
```

### åŸºå‡†æµ‹è¯•ç¤ºä¾‹

ä¸ºè‡ªå·±å†™çš„`Split`å‡½æ•°ç¼–å†™åŸºå‡†æµ‹è¯•å¦‚ä¸‹ï¼š

```go
// BenchmarkSplit åŸºå‡†æµ‹è¯•(æ€§èƒ½æµ‹è¯•)
func BenchmarkSplit(b *testing.B) {
	for i := 0; i <b.N ; i++ {
		Split("abcdebdae", "b")
	}
}

// è¾“å‡ºç»“æœå¦‚ä¸‹
goos: darwin
goarch: amd64
pkg: Gp/part5/splitStr
BenchmarkSplit
BenchmarkSplit-8   	 5740642	       209 ns/op
PASS
ok  	Gp/part5/splitStr	1.963s
```

> å…¶ä¸­
>
> BenchmarkSplitï¼šè¡¨ç¤ºå¯¹Splitå‡½æ•°è¿›è¡ŒåŸºå‡†æµ‹è¯•
>
> BenchmarkSplit-8ï¼šæ•°å­—`8`è¡¨ç¤º`GOMAXPROCS`çš„å€¼ï¼Œè¿™ä¸ªå¯¹äºå¹¶å‘åŸºå‡†æµ‹è¯•å¾ˆé‡è¦
>
> 5188407å’Œ206 ns/opï¼šè¡¨ç¤ºæ¯æ¬¡è°ƒç”¨`Split`å‡½æ•°è€—æ—¶`203ns`

è¿˜å¯ä»¥ä¸ºåŸºå‡†æµ‹è¯•æ·»åŠ `-benchmem`å‚æ•°ï¼Œæ¥è·å¾—å†…å­˜åˆ†é…çš„ç»Ÿè®¡æ•°æ®ã€‚

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gnrw3i5yuej312k07adg0.jpg)

>  112 B/opï¼šè¡¨ç¤ºæ¯æ¬¡æ“ä½œå†…å­˜åˆ†é…äº†112å­—èŠ‚
>
> `3 allocs/op`ï¼šåˆ™è¡¨ç¤ºæ¯æ¬¡æ“ä½œè¿›è¡Œäº†3æ¬¡å†…å­˜åˆ†é…ï¼ï¼ï¼

ä¼˜åŒ–åä»£ç å¦‚ä¸‹

```go
// split.go
func Split(s, sep string) (result []string) {
	i := strings.Index(s, sep)
  // æ‰‹åŠ¨åˆ†é…å›ºå®šå†…å­˜ï¼Œé¿å…å¤šæ¬¡åˆ›å»º
	result = make([]string, 0, strings.Count(s, sep)+1)
	for i > -1 {
		result = append(result, s[:i])
		s = s[i+len(sep):] // è¿™é‡Œä½¿ç”¨len(sep)è·å–sepçš„é•¿åº¦
		i = strings.Index(s, sep)
	}
	result = append(result, s)
	return
}
```

ä¼˜åŒ–åä»£ç å¦‚ä¸‹

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gnrx800j18j314g07gjrk.jpg)

> è¿™ä¸ªä½¿ç”¨makeå‡½æ•°æå‰åˆ†é…å†…å­˜çš„æ”¹åŠ¨ï¼Œå‡å°‘äº†2/3çš„å†…å­˜åˆ†é…æ¬¡æ•°ï¼Œå¹¶ä¸”å‡å°‘äº†ä¸€åŠçš„å†…å­˜åˆ†é…ã€‚
>
> ä»…ä»…å°å°çš„ä¸€å¤„æ”¹åŠ¨ï¼Œå°±å¼•èµ·å¦‚æ­¤å¤§çš„æ€§èƒ½æ”¹å˜ã€‚so good
>
> é‡å˜äº§ç”Ÿè´¨å˜

### æ€§èƒ½æ¯”è¾ƒå‡½æ•°

ä¸Šé¢çš„åŸºå‡†æµ‹è¯•åªèƒ½å¾—åˆ°ç»™å®šæ“ä½œçš„ç»å¯¹è€—æ—¶ï¼Œä½†æ˜¯åœ¨å¾ˆå¤šæ€§èƒ½é—®é¢˜æ˜¯å‘ç”Ÿåœ¨ä¸¤ä¸ªä¸åŒæ“ä½œä¹‹é—´çš„ç›¸å¯¹è€—æ—¶ï¼Œæ¯”å¦‚åŒä¸€ä¸ªå‡½æ•°å¤„ç†1000ä¸ªå…ƒç´ çš„è€—æ—¶ä¸å¤„ç†1ä¸‡ç”šè‡³100ä¸‡ä¸ªå…ƒç´ çš„è€—æ—¶çš„å·®åˆ«æ˜¯å¤šå°‘ï¼Ÿå†æˆ–è€…å¯¹äºåŒä¸€ä¸ªä»»åŠ¡ç©¶ç«Ÿä½¿ç”¨å“ªç§ç®—æ³•æ€§èƒ½æœ€ä½³ï¼Ÿé€šå¸¸éœ€è¦å¯¹ä¸¤ä¸ªä¸åŒç®—æ³•çš„å®ç°ä½¿ç”¨ç›¸åŒçš„è¾“å…¥æ¥è¿›è¡ŒåŸºå‡†æ¯”è¾ƒæµ‹è¯•ã€‚

æ€§èƒ½æ¯”è¾ƒå‡½æ•°é€šå¸¸æ˜¯ä¸€ä¸ªå¸¦æœ‰å‚æ•°çš„å‡½æ•°ï¼Œè¢«å¤šä¸ªä¸åŒçš„Benchmarkå‡½æ•°ä¼ å…¥ä¸åŒçš„å€¼æ¥è°ƒç”¨ã€‚ä¸¾ä¸ªä¾‹å­å¦‚ä¸‹ï¼š

```go
func benchmark(b *testing.B, size int){/* ... */}
func Benchmark10(b *testing.B){ benchmark(b, 10) }
func Benchmark100(b *testing.B){ benchmark(b, 100) }
func Benchmark1000(b *testing.B){ benchmark(b, 1000) }
```

ä¾‹å¦‚ç¼–å†™äº†ä¸€ä¸ªè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„å‡½æ•°å¦‚ä¸‹ï¼š

```go
// fib.go

// Fib æ˜¯ä¸€ä¸ªè®¡ç®—ç¬¬nä¸ªæ–æ³¢é‚£å¥‘æ•°çš„å‡½æ•°
func Fib(n int) int {
	if n < 2 {
		return n
	}
	return Fib(n-1) + Fib(n-2)
}
```

ç¼–å†™çš„æ€§èƒ½æ¯”è¾ƒå‡½æ•°å¦‚ä¸‹ï¼š

```go
// fib_test.go

func benchmarkFib(b *testing.B, n int) {
	for i := 0; i < b.N; i++ {
		Fib(n)
	}
}

func BenchmarkFib1(b *testing.B)  { benchmarkFib(b, 1) }
func BenchmarkFib2(b *testing.B)  { benchmarkFib(b, 2) }
func BenchmarkFib3(b *testing.B)  { benchmarkFib(b, 3) }
func BenchmarkFib10(b *testing.B) { benchmarkFib(b, 10) }
func BenchmarkFib20(b *testing.B) { benchmarkFib(b, 20) }
func BenchmarkFib40(b *testing.B) { benchmarkFib(b, 40) }
```

è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼š

```bash
split $ go test -bench=.
goos: darwin
goarch: amd64
pkg: github.com/payne/Gp/code_demo/test_demo/fib
BenchmarkFib1-8         1000000000               2.03 ns/op
BenchmarkFib2-8         300000000                5.39 ns/op
BenchmarkFib3-8         200000000                9.71 ns/op
BenchmarkFib10-8         5000000               325 ns/op
BenchmarkFib20-8           30000             42460 ns/op
BenchmarkFib40-8               2         638524980 ns/op
PASS
ok      github.com/payne/Gp/code_demo/test_demo/fib 12.944s
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåŸºå‡†æµ‹è¯•è‡³å°‘è¿è¡Œ1ç§’ã€‚å¦‚æœåœ¨Benchmarkå‡½æ•°è¿”å›æ—¶æ²¡æœ‰åˆ°1ç§’ï¼Œåˆ™b.Nçš„å€¼ä¼šæŒ‰1,2,5,10,20,50ï¼Œâ€¦å¢åŠ ï¼Œå¹¶ä¸”å‡½æ•°å†æ¬¡è¿è¡Œã€‚

æœ€ç»ˆçš„BenchmarkFib40åªè¿è¡Œäº†ä¸¤æ¬¡ï¼Œæ¯æ¬¡è¿è¡Œçš„å¹³å‡å€¼åªæœ‰ä¸åˆ°ä¸€ç§’ã€‚åƒè¿™ç§æƒ…å†µä¸‹åº”è¯¥å¯ä»¥ä½¿ç”¨`-benchtime`æ ‡å¿—å¢åŠ æœ€å°åŸºå‡†æ—¶é—´ï¼Œä»¥äº§ç”Ÿæ›´å‡†ç¡®çš„ç»“æœã€‚ä¾‹å¦‚ï¼š

```bash
split $ go test -bench=Fib40 -benchtime=20s
goos: darwin
goarch: amd64
pkg: github.com/payne/Gp/code_demo/test_demo/fib
BenchmarkFib40-8              50         663205114 ns/op
PASS
ok      github.com/payne/Gp/code_demo/test_demo/fib 33.849s
```

è¿™ä¸€æ¬¡`BenchmarkFib40`å‡½æ•°è¿è¡Œäº†50æ¬¡ï¼Œç»“æœå°±ä¼šæ›´å‡†ç¡®ä¸€äº›äº†ã€‚

ä½¿ç”¨æ€§èƒ½æ¯”è¾ƒå‡½æ•°åšæµ‹è¯•çš„æ—¶å€™ä¸€ä¸ªå®¹æ˜“çŠ¯çš„é”™è¯¯å°±æ˜¯æŠŠ`b.N`ä½œä¸ºè¾“å…¥çš„å¤§å°ï¼Œä¾‹å¦‚ä»¥ä¸‹ä¸¤ä¸ªä¾‹å­éƒ½æ˜¯é”™è¯¯çš„ç¤ºèŒƒï¼š

```go
// é”™è¯¯ç¤ºèŒƒ1
func BenchmarkFibWrong(b *testing.B) {
	for n := 0; n < b.N; n++ {
		Fib(n)
	}
}

// é”™è¯¯ç¤ºèŒƒ2
func BenchmarkFibWrong2(b *testing.B) {
	Fib(b.N)
}
```



## é‡ç½®æ—¶é—´

`b.ResetTimer`ä¹‹å‰çš„å¤„ç†ä¸ä¼šæ”¾åˆ°æ‰§è¡Œæ—¶é—´é‡Œï¼Œä¹Ÿä¸ä¼šè¾“å‡ºåˆ°æŠ¥å‘Šä¸­ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ä¹‹å‰åšä¸€äº›ä¸è®¡åˆ’ä½œä¸ºæµ‹è¯•æŠ¥å‘Šçš„æ“ä½œã€‚ä¾‹å¦‚ï¼š

```go
func BenchmarkSplit(b *testing.B) {
	time.Sleep(2 * time.Second) // å‡è®¾éœ€è¦åšä¸€äº›è€—æ—¶çš„æ— å…³æ“ä½œ
	b.ResetTimer()              // é‡ç½®è®¡æ—¶å™¨
	for i := 0; i < b.N; i++ {
		strings.Split("å±±æ²³å’Œæ²³å±±", "å’Œ")
	}
}
```

## å¹¶è¡Œæµ‹è¯•

`func (b *B) RunParallel(body func(*PB))`ä¼šä»¥å¹¶è¡Œçš„æ–¹å¼æ‰§è¡Œç»™å®šçš„åŸºå‡†æµ‹è¯•ã€‚

`RunParallel`ä¼šåˆ›å»ºå‡ºå¤šä¸ª`goroutine`ï¼Œå¹¶å°†`b.N`åˆ†é…ç»™è¿™äº›`goroutine`æ‰§è¡Œï¼Œ å…¶ä¸­`goroutine`æ•°é‡çš„é»˜è®¤å€¼ä¸º`GOMAXPROCS`ã€‚ç”¨æˆ·å¦‚æœæƒ³è¦å¢åŠ éCPUå—é™ï¼ˆnon-CPU-boundï¼‰åŸºå‡†æµ‹è¯•çš„å¹¶è¡Œæ€§ï¼Œ é‚£ä¹ˆå¯ä»¥åœ¨`RunParallel`ä¹‹å‰è°ƒç”¨`SetParallelism` ã€‚`RunParallel`é€šå¸¸ä¼šä¸`-cpu`æ ‡å¿—ä¸€åŒä½¿ç”¨ã€‚

```go
func BenchmarkSplitParallel(b *testing.B) {
	// b.SetParallelism(1) // è®¾ç½®ä½¿ç”¨çš„CPUæ•°
	b.RunParallel(func(pb *testing.PB) {
		for pb.Next() {
			Split("å±±æ²³å’Œæ²³å±±", "å’Œ")
		}
	})
}
```

æ‰§è¡Œä¸€ä¸‹åŸºå‡†æµ‹è¯•ï¼š

```bash
split $ go test -bench=.
goos: darwin
goarch: amd64
pkg: github.com/payne/Gp/code_demo/test_demo/split
BenchmarkSplit-8                10000000               131 ns/op
BenchmarkSplitParallel-8        50000000                36.1 ns/op
PASS
ok      github.com/payne/Gp/code_demo/test_demo/split       3.308s
```

è¿˜å¯ä»¥é€šè¿‡åœ¨æµ‹è¯•å‘½ä»¤åæ·»åŠ `-cpu`å‚æ•°å¦‚`go test -bench=. -cpu 1`æ¥æŒ‡å®šä½¿ç”¨çš„CPUæ•°é‡ã€‚

## Setupä¸TearDown

æµ‹è¯•ç¨‹åºæœ‰æ—¶éœ€è¦åœ¨æµ‹è¯•ä¹‹å‰è¿›è¡Œé¢å¤–çš„è®¾ç½®ï¼ˆsetupï¼‰æˆ–åœ¨æµ‹è¯•ä¹‹åè¿›è¡Œæ‹†å¸ï¼ˆteardownï¼‰ã€‚



## Goæ€§èƒ½ä¼˜åŒ–

åšäº†è¿™ä¹ˆå¤šçš„æµ‹è¯•æœ€ç»ˆçš„ç›®çš„æ˜¯æµ‹è¯•ä»£ç æœ‰æ²¡æœ‰å†™å¯¹ï¼Œæ€§èƒ½æ˜¯å¦å¯ä»¥ä¼˜åŒ–ã€‚æ¥ä¸‹æ¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜

åœ¨è®¡ç®—æœºæ€§èƒ½è°ƒè¯•é¢†åŸŸé‡Œï¼Œprofiling æ˜¯æŒ‡å¯¹åº”ç”¨ç¨‹åºçš„ç”»åƒï¼Œç”»åƒå°±æ˜¯åº”ç”¨ç¨‹åºä½¿ç”¨ CPU å’Œå†…å­˜çš„æƒ…å†µã€‚ Goè¯­è¨€æ˜¯ä¸€ä¸ªå¯¹æ€§èƒ½ç‰¹åˆ«çœ‹é‡çš„è¯­è¨€ï¼Œå› æ­¤è¯­è¨€ä¸­è‡ªå¸¦äº† profiling çš„åº“ã€‚

Goè¯­è¨€é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- CPU profileï¼šæŠ¥å‘Šç¨‹åºçš„ CPU ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰ç…§ä¸€å®šé¢‘ç‡å»é‡‡é›†åº”ç”¨ç¨‹åºåœ¨ CPU å’Œå¯„å­˜å™¨ä¸Šé¢çš„æ•°æ®
- Memory Profileï¼ˆHeap Profileï¼‰ï¼šæŠ¥å‘Šç¨‹åºçš„å†…å­˜çš„ä½¿ç”¨æƒ…å†µ
- Block Profilingï¼šæŠ¥å‘Š goroutine ä¸åœ¨è¿è¡ŒçŠ¶æ€çš„æƒ…å†µï¼Œå¯ä»¥ç”¨æ¥åˆ†æä¸æŸ¥æ‰¾æ­»é”ç­‰æ€§èƒ½ç“¶é¢ˆ
- Goroutine Profilingï¼šæŠ¥å‘Š goroutines çš„ä½¿ç”¨æƒ…å†µï¼Œæœ‰å“ªäº› goroutineï¼Œå®ƒä»¬çš„è°ƒç”¨å…³ç³»æ˜¯æ€æ ·çš„

### é‡‡é›†æ€§èƒ½æ•°æ®

Goè¯­è¨€å†…ç½®äº†è·å–ç¨‹åºçš„è¿è¡Œæ•°æ®çš„å·¥å…·ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªæ ‡å‡†åº“ï¼š

- `runtime/pprof`ï¼šé‡‡é›†å·¥å…·å‹åº”ç”¨è¿è¡Œæ•°æ®è¿›è¡Œåˆ†æ
- `net/http/pprof`ï¼šé‡‡é›†æœåŠ¡å‹åº”ç”¨è¿è¡Œæ—¶æ•°æ®è¿›è¡Œåˆ†æ

pprofå¼€å¯åï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆ10msï¼‰å°±ä¼šæ”¶é›†ä¸‹å½“å‰çš„å †æ ˆä¿¡æ¯ï¼Œè·å–å„ä¸ªå‡½æ•°å ç”¨çš„CPUä»¥åŠå†…å­˜èµ„æºï¼›æœ€åé€šè¿‡å¯¹è¿™äº›é‡‡æ ·æ•°æ®è¿›è¡Œåˆ†æï¼Œå½¢æˆä¸€ä¸ªæ€§èƒ½åˆ†ææŠ¥å‘Šã€‚

### pprofåº”ç”¨

å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ˜¯è¿è¡Œä¸€æ®µæ—¶é—´å°±ç»“æŸé€€å‡ºç±»å‹ã€‚é‚£ä¹ˆæœ€å¥½çš„åŠæ³•æ˜¯åœ¨åº”ç”¨é€€å‡ºçš„æ—¶å€™æŠŠ profiling çš„æŠ¥å‘Šä¿å­˜åˆ°æ–‡ä»¶ä¸­ï¼Œè¿›è¡Œåˆ†æã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨`runtime/pprof`åº“ã€‚ é¦–å…ˆåœ¨ä»£ç ä¸­å¯¼å…¥`runtime/pprof`å·¥å…·ï¼š

```go
import "runtime/pprof"
```

### CPUæ€§èƒ½åˆ†æ

å¼€å¯CPUæ€§èƒ½åˆ†æï¼š

```go
pprof.StartCPUProfile(w io.Writer)
```

åœæ­¢CPUæ€§èƒ½åˆ†æï¼š

```go
pprof.StopCPUProfile()
```

åº”ç”¨æ‰§è¡Œç»“æŸåï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜äº† CPU profiling æ•°æ®ã€‚å¾—åˆ°é‡‡æ ·æ•°æ®ä¹‹åï¼Œä½¿ç”¨`go tool pprof`å·¥å…·è¿›è¡ŒCPUæ€§èƒ½åˆ†æã€‚

### å†…å­˜æ€§èƒ½ä¼˜åŒ–

è®°å½•ç¨‹åºçš„å †æ ˆä¿¡æ¯

```go
pprof.WriteHeapProfile(w io.Writer)
```

å¾—åˆ°é‡‡æ ·æ•°æ®ä¹‹åï¼Œä½¿ç”¨`go tool pprof`å·¥å…·è¿›è¡Œå†…å­˜æ€§èƒ½åˆ†æã€‚

`go tool pprof`é»˜è®¤æ˜¯ä½¿ç”¨`-inuse_space`è¿›è¡Œç»Ÿè®¡ï¼Œè¿˜å¯ä»¥ä½¿ç”¨`-inuse-objects`æŸ¥çœ‹åˆ†é…å¯¹è±¡çš„æ•°é‡ã€‚

## æœåŠ¡å‹åº”ç”¨

å¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ˜¯ä¸€ç›´è¿è¡Œçš„ï¼Œæ¯”å¦‚ web åº”ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨`net/http/pprof`åº“ï¼Œå®ƒèƒ½å¤Ÿåœ¨æä¾› HTTP æœåŠ¡è¿›è¡Œåˆ†æã€‚

å¦‚æœä½¿ç”¨äº†é»˜è®¤çš„`http.DefaultServeMux`ï¼ˆé€šå¸¸æ˜¯ä»£ç ç›´æ¥ä½¿ç”¨ http.ListenAndServe(â€œ0.0.0.0:8000â€, nil)ï¼‰ï¼Œåªéœ€è¦åœ¨ä½ çš„web serverç«¯ä»£ç ä¸­æŒ‰å¦‚ä¸‹æ–¹å¼å¯¼å…¥`net/http/pprof`

```go
import _ "net/http/pprof"
```

å¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰çš„ Muxï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ³¨å†Œä¸€äº›è·¯ç”±è§„åˆ™ï¼š

```go
r.HandleFunc("/debug/pprof/", pprof.Index)
r.HandleFunc("/debug/pprof/cmdline", pprof.Cmdline)
r.HandleFunc("/debug/pprof/profile", pprof.Profile)
r.HandleFunc("/debug/pprof/symbol", pprof.Symbol)
r.HandleFunc("/debug/pprof/trace", pprof.Trace)
```

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ginæ¡†æ¶ï¼Œæ¨èä½¿ç”¨[github.com/gin-contrib/pprof](https://github.com/gin-contrib/pprof)ï¼Œåœ¨ä»£ç ä¸­é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ³¨å†Œpprofç›¸å…³è·¯ç”±ã€‚

```go
pprof.Register(router)
```

ä¸ç®¡å“ªç§æ–¹å¼ï¼Œä½ çš„ HTTP æœåŠ¡éƒ½ä¼šå¤šå‡º`/debug/pprof` endpointï¼Œè®¿é—®å®ƒä¼šå¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„å†…å®¹ï¼š

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gpih7cgmhxj30hu0jwmy0.jpg)

è¿™ä¸ªè·¯å¾„ä¸‹è¿˜æœ‰å‡ ä¸ªå­é¡µé¢ï¼š

- /debug/pprof/profileï¼šè®¿é—®è¿™ä¸ªé“¾æ¥ä¼šè‡ªåŠ¨è¿›è¡Œ CPU profilingï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ä¾›ä¸‹è½½
- /debug/pprof/heapï¼š Memory Profiling çš„è·¯å¾„ï¼Œè®¿é—®è¿™ä¸ªé“¾æ¥ä¼šå¾—åˆ°ä¸€ä¸ªå†…å­˜ Profiling ç»“æœçš„æ–‡ä»¶
- /debug/pprof/blockï¼šblock Profiling çš„è·¯å¾„
- /debug/pprof/goroutinesï¼šè¿è¡Œçš„ goroutines åˆ—è¡¨ï¼Œä»¥åŠè°ƒç”¨å…³ç³»

- ã€‚ã€‚ã€‚ ã€‚ã€‚ã€‚

### go tool pprofå‘½ä»¤

ä¸ç®¡æ˜¯å·¥å…·å‹åº”ç”¨è¿˜æ˜¯æœåŠ¡å‹åº”ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åº”çš„pprofåº“è·å–æ•°æ®ä¹‹åï¼Œä¸‹ä¸€æ­¥çš„éƒ½è¦å¯¹è¿™äº›æ•°æ®è¿›è¡Œåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`go tool pprof`å‘½ä»¤è¡Œå·¥å…·ã€‚

`go tool pprof`æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼ä¸º:

```bash
go tool pprof [binary] [source]
```

å…¶ä¸­ï¼š

- binary æ˜¯åº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç”¨æ¥è§£æå„ç§ç¬¦å·ï¼›
- source è¡¨ç¤º profile æ•°æ®çš„æ¥æºï¼Œå¯ä»¥æ˜¯æœ¬åœ°çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ http åœ°å€ã€‚

**æ³¨æ„äº‹é¡¹ï¼š** è·å–çš„ Profiling æ•°æ®æ˜¯åŠ¨æ€çš„ï¼Œè¦æƒ³è·å¾—æœ‰æ•ˆçš„æ•°æ®ï¼Œè¯·ä¿è¯åº”ç”¨å¤„äºè¾ƒå¤§çš„è´Ÿè½½ï¼ˆæ¯”å¦‚æ­£åœ¨ç”Ÿæˆä¸­è¿è¡Œçš„æœåŠ¡ï¼Œæˆ–è€…é€šè¿‡å…¶ä»–å·¥å…·æ¨¡æ‹Ÿè®¿é—®å‹åŠ›ï¼‰ã€‚å¦åˆ™å¦‚æœåº”ç”¨å¤„äºç©ºé—²çŠ¶æ€ï¼Œå¾—åˆ°çš„ç»“æœå¯èƒ½æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚

### å‘½ä»¤è¡Œäº¤äº’ç•Œé¢

æˆ‘ä»¬ä½¿ç”¨goå·¥å…·é“¾é‡Œçš„`pprof`æ¥åˆ†æä¸€ä¸‹ã€‚

```bash
go tool pprof cpu.pprof
```

æ‰§è¡Œä¸Šé¢çš„ä»£ç ä¼šè¿›å…¥äº¤äº’ç•Œé¢å¦‚ä¸‹ï¼š

```bash
runtime_pprof $ go tool pprof cpu.pprof
Type: cpu
Time: Jun 28, 2020 at 11:28am (CST)
Duration: 20.13s, Total samples = 1.91mins (538.60%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof)  
```

æˆ‘ä»¬å¯ä»¥åœ¨äº¤äº’ç•Œé¢è¾“å…¥`top3`æ¥æŸ¥çœ‹ç¨‹åºä¸­å ç”¨CPUå‰3ä½çš„å‡½æ•°ï¼š

```bash
(pprof) top3
Showing nodes accounting for 100.37s, 87.68% of 114.47s total
Dropped 17 nodes (cum <= 0.57s)
Showing top 3 nodes out of 4
      flat  flat%   sum%        cum   cum%
    42.52s 37.15% 37.15%     91.73s 80.13%  runtime.selectnbrecv
    35.21s 30.76% 67.90%     39.49s 34.50%  runtime.chanrecv
    22.64s 19.78% 87.68%    114.37s 99.91%  main.logicCode
```

å…¶ä¸­ï¼š

- flatï¼šå½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶
- flatï¼š:å½“å‰å‡½æ•°å ç”¨CPUçš„è€—æ—¶ç™¾åˆ†æ¯”
- sun%ï¼šå‡½æ•°å ç”¨CPUçš„è€—æ—¶ç´¯è®¡ç™¾åˆ†æ¯”
- cumï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶
- cum%ï¼šå½“å‰å‡½æ•°åŠ ä¸Šè°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°å ç”¨CPUçš„æ€»è€—æ—¶ç™¾åˆ†æ¯”
- æœ€åä¸€åˆ—ï¼šå‡½æ•°åç§°

åœ¨å¤§å¤šæ•°çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æè¿™äº”åˆ—å¾—å‡ºä¸€ä¸ªåº”ç”¨ç¨‹åºçš„è¿è¡Œæƒ…å†µï¼Œå¹¶å¯¹ç¨‹åºè¿›è¡Œä¼˜åŒ–ã€‚

è¿˜å¯ä»¥ä½¿ç”¨`list å‡½æ•°å`å‘½ä»¤æŸ¥çœ‹å…·ä½“çš„å‡½æ•°åˆ†æï¼Œä¾‹å¦‚æ‰§è¡Œ`list logicCode`æŸ¥çœ‹æˆ‘ä»¬ç¼–å†™çš„å‡½æ•°çš„è¯¦ç»†åˆ†æã€‚

### å›¾å½¢åŒ–

æˆ–è€…å¯ä»¥ç›´æ¥è¾“å…¥webï¼Œé€šè¿‡svgå›¾çš„æ–¹å¼æŸ¥çœ‹ç¨‹åºä¸­è¯¦ç»†çš„CPUå ç”¨æƒ…å†µã€‚ æƒ³è¦æŸ¥çœ‹å›¾å½¢åŒ–çš„ç•Œé¢é¦–å…ˆéœ€è¦å®‰è£…[graphviz](https://graphviz.gitlab.io/)å›¾å½¢åŒ–å·¥å…·ã€‚

Macï¼š

```bash
brew install graphviz
```

Windows: ä¸‹è½½[graphviz](https://graphviz.gitlab.io/_pages/Download/Download_windows.html) å°†`graphviz`å®‰è£…ç›®å½•ä¸‹çš„binæ–‡ä»¶å¤¹æ·»åŠ åˆ°Pathç¯å¢ƒå˜é‡ä¸­ã€‚ åœ¨ç»ˆç«¯è¾“å…¥`dot -version`æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸã€‚

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gpihc6efdzj310a0q676g.jpg)

å…³äºå›¾å½¢çš„è¯´æ˜ï¼š æ¯ä¸ªæ¡†ä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼Œç†è®ºä¸Šæ¡†çš„è¶Šå¤§è¡¨ç¤ºå ç”¨çš„CPUèµ„æºè¶Šå¤šã€‚ æ–¹æ¡†ä¹‹é—´çš„çº¿æ¡ä»£è¡¨å‡½æ•°ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€‚ çº¿æ¡ä¸Šçš„æ•°å­—è¡¨ç¤ºå‡½æ•°è°ƒç”¨çš„æ¬¡æ•°ã€‚ æ–¹æ¡†ä¸­çš„ç¬¬ä¸€è¡Œæ•°å­—è¡¨ç¤ºå½“å‰å‡½æ•°å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œç¬¬äºŒè¡Œæ•°å­—è¡¨ç¤ºå½“å‰å‡½æ•°ç´¯è®¡å ç”¨CPUçš„ç™¾åˆ†æ¯”ã€‚

é™¤äº†åˆ†æCPUæ€§èƒ½æ•°æ®ï¼Œpprofä¹Ÿæ”¯æŒåˆ†æå†…å­˜æ€§èƒ½æ•°æ®ã€‚æ¯”å¦‚ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åˆ†æhttpæœåŠ¡çš„heapæ€§èƒ½æ•°æ®ï¼ŒæŸ¥çœ‹å½“å‰ç¨‹åºçš„å†…å­˜å ç”¨ä»¥åŠçƒ­ç‚¹å†…å­˜å¯¹è±¡ä½¿ç”¨çš„æƒ…å†µã€‚

```bash
# æŸ¥çœ‹å†…å­˜å ç”¨æ•°æ®
go tool pprof -inuse_space http://127.0.0.1:8080/debug/pprof/heap
go tool pprof -inuse_objects http://127.0.0.1:8080/debug/pprof/heap
# æŸ¥çœ‹ä¸´æ—¶å†…å­˜åˆ†é…æ•°æ®
go tool pprof -alloc_space http://127.0.0.1:8080/debug/pprof/heap
go tool pprof -alloc_objects http://127.0.0.1:8080/debug/pprof/heap
```

## go-torchå’Œç«ç„°å›¾

ç«ç„°å›¾ï¼ˆFlame Graphï¼‰æ˜¯ Bredan Gregg åˆ›å»ºçš„ä¸€ç§æ€§èƒ½åˆ†æå›¾è¡¨ï¼Œå› ä¸ºå®ƒçš„æ ·å­è¿‘ä¼¼ ğŸ”¥è€Œå¾—åã€‚ä¸Šé¢çš„ profiling ç»“æœä¹Ÿè½¬æ¢æˆç«ç„°å›¾ï¼Œå¦‚æœå¯¹ç«ç„°å›¾æ¯”è¾ƒäº†è§£å¯ä»¥æ‰‹åŠ¨æ¥æ“ä½œï¼Œä¸è¿‡è¿™é‡Œæˆ‘ä»¬è¦ä»‹ç»ä¸€ä¸ªå·¥å…·ï¼š`go-torch`ã€‚è¿™æ˜¯ uber å¼€æºçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç›´æ¥è¯»å– golang profiling æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç«ç„°å›¾çš„ svg æ–‡ä»¶ã€‚

### å®‰è£…go-torch

```bash
   go get -v github.com/uber/go-torch
```

ç«ç„°å›¾ svg æ–‡ä»¶å¯ä»¥é€šè¿‡æµè§ˆå™¨æ‰“å¼€ï¼Œå®ƒå¯¹äºè°ƒç”¨å›¾çš„æœ€ä¼˜ç‚¹æ˜¯å®ƒæ˜¯åŠ¨æ€çš„ï¼šå¯ä»¥é€šè¿‡ç‚¹å‡»æ¯ä¸ªæ–¹å—æ¥ zoom in åˆ†æå®ƒä¸Šé¢çš„å†…å®¹ã€‚

ç«ç„°å›¾çš„è°ƒç”¨é¡ºåºä»ä¸‹åˆ°ä¸Šï¼Œæ¯ä¸ªæ–¹å—ä»£è¡¨ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒä¸Šé¢ä¸€å±‚è¡¨ç¤ºè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨å“ªäº›å‡½æ•°ï¼Œæ–¹å—çš„å¤§å°ä»£è¡¨äº†å ç”¨ CPU ä½¿ç”¨çš„é•¿çŸ­ã€‚ç«ç„°å›¾çš„é…è‰²å¹¶æ²¡æœ‰ç‰¹æ®Šçš„æ„ä¹‰ï¼Œé»˜è®¤çš„çº¢ã€é»„é…è‰²æ˜¯ä¸ºäº†æ›´åƒç«ç„°è€Œå·²ã€‚

go-torch å·¥å…·çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œæ²¡æœ‰ä»»ä½•å‚æ•°çš„è¯ï¼Œå®ƒä¼šå°è¯•ä»`http://localhost:8080/debug/pprof/profile`è·å– profiling æ•°æ®ã€‚å®ƒæœ‰ä¸‰ä¸ªå¸¸ç”¨çš„å‚æ•°å¯ä»¥è°ƒæ•´ï¼š

- -u â€“urlï¼šè¦è®¿é—®çš„ URLï¼Œè¿™é‡Œåªæ˜¯ä¸»æœºå’Œç«¯å£éƒ¨åˆ†
- -s â€“suffixï¼špprof profile çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º /debug/pprof/profile
- â€“secondsï¼šè¦æ‰§è¡Œ profiling çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤ä¸º 30s

### å®‰è£… FlameGraph

è¦ç”Ÿæˆç«ç„°å›¾ï¼Œéœ€è¦äº‹å…ˆå®‰è£… FlameGraphå·¥å…·ï¼Œè¿™ä¸ªå·¥å…·çš„å®‰è£…å¾ˆç®€å•ï¼ˆéœ€è¦perlç¯å¢ƒæ”¯æŒï¼‰ï¼Œåªè¦æŠŠå¯¹åº”çš„å¯æ‰§è¡Œæ–‡ä»¶åŠ å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­å³å¯ã€‚

1. ä¸‹è½½å®‰è£…perlï¼šhttps://www.perl.org/get.html
2. ä¸‹è½½FlameGraphï¼š`git clone https://github.com/brendangregg/FlameGraph.git`
3. å°†`FlameGraph`ç›®å½•åŠ å…¥åˆ°æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ä¸­ã€‚
4. Windowså¹³å°ï¼Œéœ€è¦æŠŠ`go-torch/render/flamegraph.go`æ–‡ä»¶ä¸­çš„`GenerateFlameGraph`æŒ‰å¦‚ä¸‹æ–¹å¼ä¿®æ”¹ï¼Œç„¶ååœ¨`go-torch`ç›®å½•ä¸‹æ‰§è¡Œ`go install`å³å¯ã€‚

```go
// GenerateFlameGraph runs the flamegraph script to generate a flame graph SVG. func GenerateFlameGraph(graphInput []byte, args ...string) ([]byte, error) {
flameGraph := findInPath(flameGraphScripts)
if flameGraph == "" {
	return nil, errNoPerlScript
}
if runtime.GOOS == "windows" {
	return runScript("perl", append([]string{flameGraph}, args...), graphInput)
}
  return runScript(flameGraph, args, graphInput)
}
```

### å‹æµ‹å·¥å…·wrk

æ¨èä½¿ç”¨https://github.com/wg/wrk æˆ– https://github.com/adjust/go-wrk

### ä½¿ç”¨go-torch

ä½¿ç”¨wrkè¿›è¡Œå‹æµ‹:

```bash
go-wrk -n 50000 http://127.0.0.1:8080/book/list
```

åœ¨ä¸Šé¢å‹æµ‹è¿›è¡Œçš„åŒæ—¶ï¼Œæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œ:

```bash
go-torch -u http://127.0.0.1:8080 -t 30
```

30ç§’ä¹‹åç»ˆç«¯ä¼šå‡ºç°å¦‚ä¸‹æç¤ºï¼š`Writing svg to torch.svg`

ç„¶åæˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€`torch.svg`å°±èƒ½çœ‹åˆ°å¦‚ä¸‹ç«ç„°å›¾äº†ã€‚

ç«ç„°å›¾çš„yè½´è¡¨ç¤ºcpuè°ƒç”¨æ–¹æ³•çš„å…ˆåï¼Œxè½´è¡¨ç¤ºåœ¨æ¯ä¸ªé‡‡æ ·è°ƒç”¨æ—¶é—´å†…ï¼Œæ–¹æ³•æ‰€å çš„æ—¶é—´ç™¾åˆ†æ¯”ï¼Œè¶Šå®½ä»£è¡¨å æ®cpuæ—¶é—´è¶Šå¤šã€‚é€šè¿‡ç«ç„°å›¾æˆ‘ä»¬å°±å¯ä»¥æ›´æ¸…æ¥šçš„æ‰¾å‡ºè€—æ—¶é•¿çš„å‡½æ•°è°ƒç”¨ï¼Œç„¶åä¸æ–­çš„ä¿®æ­£ä»£ç ï¼Œé‡æ–°é‡‡æ ·ï¼Œä¸æ–­ä¼˜åŒ–ã€‚

æ­¤å¤–è¿˜å¯ä»¥å€ŸåŠ©ç«ç„°å›¾åˆ†æå†…å­˜æ€§èƒ½æ•°æ®ï¼š

```bash
go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap
go-torch -inuse_objects http://127.0.0.1:8080/debug/pprof/heap
go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap
go-torch -alloc_objects http://127.0.0.1:8080/debug/pprof/heap
```

## pprofä¸æ€§èƒ½æµ‹è¯•ç»“åˆ

`go test`å‘½ä»¤æœ‰ä¸¤ä¸ªå‚æ•°å’Œ pprof ç›¸å…³ï¼Œå®ƒä»¬åˆ†åˆ«æŒ‡å®šç”Ÿæˆçš„ CPU å’Œ Memory profiling ä¿å­˜çš„æ–‡ä»¶ï¼š

- -cpuprofileï¼šcpu profiling æ•°æ®è¦ä¿å­˜çš„æ–‡ä»¶åœ°å€
- -memprofileï¼šmemory profiling æ•°æ®è¦æŠ¥æ–‡çš„æ–‡ä»¶åœ°å€

æˆ‘ä»¬è¿˜å¯ä»¥é€‰æ‹©å°†pprofä¸æ€§èƒ½æµ‹è¯•ç›¸ç»“åˆï¼Œæ¯”å¦‚ï¼š

æ¯”å¦‚ä¸‹é¢æ‰§è¡Œæµ‹è¯•çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œ CPU profilingï¼Œå¹¶æŠŠç»“æœä¿å­˜åœ¨ cpu.prof æ–‡ä»¶ä¸­ï¼š

```bash
go test -bench . -cpuprofile=cpu.prof
```

æ¯”å¦‚ä¸‹é¢æ‰§è¡Œæµ‹è¯•çš„åŒæ—¶ï¼Œä¹Ÿä¼šæ‰§è¡Œ Mem profilingï¼Œå¹¶æŠŠç»“æœä¿å­˜åœ¨ cpu.prof æ–‡ä»¶ä¸­ï¼š

```bash
go test -bench . -memprofile=./mem.prof
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒProfiling ä¸€èˆ¬å’Œæ€§èƒ½æµ‹è¯•ä¸€èµ·ä½¿ç”¨ï¼Œè¿™ä¸ªåŸå› åœ¨å‰æ–‡ä¹Ÿæåˆ°è¿‡ï¼Œåªæœ‰åº”ç”¨åœ¨è´Ÿè½½é«˜çš„æƒ…å†µä¸‹ Profiling æ‰æœ‰æ„ä¹‰ã€‚

## referce

[ææ–‡å‘¨-Goæ€§èƒ½ä¼˜åŒ–](https://www.liwenzhou.com/posts/Go/performance_optimisation/)